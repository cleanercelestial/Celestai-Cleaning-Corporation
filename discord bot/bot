import discord
from discord.ext import commands
from discord import app_commands
import json
import os
from typing import Optional, Literal
import asyncio
from datetime import datetime
import aiohttp
import random
from functools import wraps
from datetime import datetime, timedelta

# Bot è¨­å®š
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

bot = commands.Bot(command_prefix='!', intents=intents)

# æ•¸æ“šå­˜å„²æ–‡ä»¶
DATA_FILE = 'celestial_data.json'
SHOP_FILE = 'shop_data.json'
SCENE_ITEMS_FILE = 'scene_items.json'
MISSIONS_DIR = 'missions'
AVATARS_DIR = 'avatars'

# ç¢ºä¿ç›®éŒ„å­˜åœ¨
for directory in [AVATARS_DIR, MISSIONS_DIR]:
    if not os.path.exists(directory):
        os.makedirs(directory)

# ================= è¼”åŠ©å‡½æ•¸ï¼šè² é‡ç²¾ç¢ºè¨ˆç®— ==================
def round_weight(weight):
    """å°‡è² é‡å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ2ä½ï¼Œé¿å…æµ®é»æ•¸èª¤å·®"""
    return round(float(weight), 2)

# ==================== æ”»æ“ŠåŠ›åŠ æˆé…ç½® ====================

ATTACK_BONUS_CONFIG = {
    'ranges': [
        {'min': 0,   'max': 20,  'bonus': -30},  # åŠ›é‡ 0-20:  -30 æ”»æ“ŠåŠ›
        {'min': 21,  'max': 40,  'bonus': -20},  # åŠ›é‡ 21-40: -20 æ”»æ“ŠåŠ›
        {'min': 41,  'max': 60,  'bonus': -10},  # åŠ›é‡ 41-60: -10 æ”»æ“ŠåŠ›
        {'min': 61,  'max': 80,  'bonus': 0},    # åŠ›é‡ 61-80: ç„¡åŠ æˆ
        {'min': 81,  'max': 100, 'bonus': 10},   # åŠ›é‡ 81-100: +10 æ”»æ“ŠåŠ›
        {'min': 101, 'max': 120, 'bonus': 25},   # åŠ›é‡ 101-120: +25 æ”»æ“ŠåŠ›
        {'min': 121, 'max': 150, 'bonus': 40},   # åŠ›é‡ 121-150: +40 æ”»æ“ŠåŠ›
        {'min': 151, 'max': 200, 'bonus': 60},   # åŠ›é‡ 151-200: +60 æ”»æ“ŠåŠ›
        {'min': 201, 'max': 999, 'bonus': 100},  # åŠ›é‡ 201+: +100 æ”»æ“ŠåŠ›
    ]
}

def get_strength_bonus(strength_value):
    """
    æ ¹æ“šåŠ›é‡å€¼ç²å–æ”»æ“ŠåŠ›åŠ æˆ
    
    åƒæ•¸:
        strength_value: åŠ›é‡å€¼
    
    è¿”å›:
        åŠ æˆæ•¸å€¼ï¼ˆå¯ç‚ºè² æ•¸ï¼‰
    """
    for range_config in ATTACK_BONUS_CONFIG['ranges']:
        if range_config['min'] <= strength_value <= range_config['max']:
            return range_config['bonus']
    
    # å¦‚æœè¶…å‡ºæ‰€æœ‰ç¯„åœï¼Œè¿”å›æœ€é«˜åŠ æˆ
    return ATTACK_BONUS_CONFIG['ranges'][-1]['bonus']


def calculate_attack_damage(user_data, base_damage):
    """
    è¨ˆç®—æœ€çµ‚æ”»æ“Šå‚·å®³ï¼ˆå«åŠ›é‡åŠ æˆï¼‰
    
    åƒæ•¸:
        user_data: ç©å®¶æ•¸æ“š
        base_damage: åŸºç¤å‚·å®³
    
    è¿”å›:
        å­—å…¸ï¼ŒåŒ…å«è©³ç´°è¨ˆç®—è³‡è¨Š
    """
    strength = user_data['stats'].get('åŠ›é‡å€¼', 0)
    bonus = get_strength_bonus(strength)
    
    final_damage = max(base_damage + bonus, 1)  # æœ€ä½å‚·å®³ç‚º 1
    
    return {
        'base_damage': base_damage,
        'strength': strength,
        'bonus': bonus,
        'final_damage': final_damage,
        'is_buffed': bonus > 0,
        'is_debuffed': bonus < 0
    }


# ==================== ç®¡ç†å“¡ä½œå¼Šè£é£¾å™¨ ====================
def dev_cheat(func):
    @wraps(func)
    async def wrapper(ctx, *args, **kwargs):
        user_id = str(ctx.author.id)  
       
        if user_id != "934982547132272641":  # åŠ ä¸Šå¼•è™Ÿ
            await ctx.send("âŒ ä½ æ²’æœ‰æ¬Šé™ä½¿ç”¨é€™å€‹æŒ‡ä»¤ï¼")  # ä¿®æ­£éŒ¯å­—
            return
        
        # âœ… å¦‚æœæ˜¯ç®¡ç†å“¡ï¼ŒåŸ·è¡ŒåŸå‡½æ•¸
        return await func(ctx, *args, **kwargs)
    
    return wrapper


# ==================== æ­»äº¡æª¢æŸ¥è£é£¾å™¨ ====================
def check_alive(func):
    """æª¢æŸ¥ç©å®¶æ˜¯å¦å­˜æ´»çš„è£é£¾å™¨"""
    @wraps(func)
    async def wrapper(ctx, *args, **kwargs):
        data = load_data()
        user_id = str(ctx.author.id)
        
        if user_id not in data:
            await ctx.send("âŒ ä½ é‚„æ²’æœ‰å‰µå»ºè§’è‰²ï¼ä½¿ç”¨ `!start` é–‹å§‹å‰µå»ºã€‚")
            return
        
        user_data = data[user_id]
        
        if user_data.get('is_dead', False):
            embed = discord.Embed(
                title="ğŸ’€ ä½ å·²ç¶“æ­»äº¡ï¼",
                description="ä½ ç›®å‰è™•æ–¼æ­»äº¡ç‹€æ…‹ï¼Œç„¡æ³•é€²è¡Œä»»ä½•è¡Œå‹•ã€‚\n\n"
                           "**å¾©æ´»æ¢ä»¶ï¼š**\n"
                           "â€¢ ç­‰å¾…ç•¶å‰ä»»å‹™å®Œæˆå¾Œè‡ªå‹•å•Ÿå‹•ç”Ÿç‰©æ‰“å°\n"
                           "â€¢ æˆ–ä½¿ç”¨ `!print` æŒ‡ä»¤ï¼ˆéœ€ä»»å‹™å·²å®Œæˆï¼‰",
                color=discord.Color.dark_red()
            )
            embed.add_field(
                name="ç•¶å‰ä»»å‹™",
                value=user_data.get('current_mission') or "ç„¡ï¼ˆå¯ä»¥ä½¿ç”¨ !print å•Ÿå‹•ç”Ÿç‰©æ‰“å°ï¼‰",
                inline=False
            )
            embed.add_field(
                name="æ­»äº¡æ¬¡æ•¸",
                value=f"â˜ ï¸ {user_data.get('death_count', 0)}",
                inline=True
            )
            set_embed_footer(embed, ctx)
            await ctx.send(embed=embed)
            return
        
        return await func(ctx, *args, **kwargs)
    
    return wrapper

# åˆå§‹åŒ–æ•¸æ“šçµæ§‹
def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}

def save_data(data):
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def load_items():
    if os.path.exists(SHOP_FILE):
        with open(SHOP_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {
        "æ¸…æ½”è¨­å‚™": {
            "æ¸…æ½”å·¥æƒæŠŠ": {
                "price": 1, 
                "weight": 0.6, 
                "description": "æ¯ä½æ˜Ÿéš›æ¸…æ½”å·¥å…¥è·å¾Œè‡ªå‹•é…çµ¦çš„å…¥é–€ç´šæƒæŠŠï¼Œé™¤éä½ å¾ˆé›–å°æŠŠå®ƒæä¸Ÿäº†ã€‚",
                "type": "tool",
                "reagents": {
                    "æ¨™æº–æ¸…æ½”åŠ‘": 100,
                    "ç‰¹æ®Šæ¸…æ½”åŠ‘": 100
                }
            },
            "æ¸…æ½”å·¥æƒæŠŠpro": {
                "price": 1, 
                "weight": 0.35, 
                "description": "æ¯”èµ·æ™®é€šæ¸…æ½”å·¥æƒæŠŠæ›´å¼·å¤§çš„æ¸…æ½”åŠ›ï¼çºŒèˆªåŠ›maxï¼Œç„¡éœ€æ›æ°´ï¼Œ0æ­»è§’æ¸…æ½”ï¼",
                "type": "tool",
                "reagents": {
                    "æ¨™æº–æ¸…æ½”åŠ‘": 500,
                    "ç‰¹æ®Šæ¸…æ½”åŠ‘": 500
                }
            },
            "å…¨æ¯æƒæå„€": {
                "price": 1, 
                "weight": 1.2, 
                "description": "ç”¨æ–¼æƒæåŠå®šä½å‘¨é­å¯è¦‹åƒåœ¾ï¼Œé…å‚™æ°£é«”åˆ†æåŠŸèƒ½ã€‚",
                "type": "tool"
            },
            "å¤§å‹ç‰©ä»¶åˆ†è§£æ§": {
                "price": 1, 
                "weight": 0.4, 
                "description": "ç”¨æ–¼åˆ†è§£å¤§å‹ç‰©ä»¶ï¼Œè«‹å‹¿æœå¥å…¨å“¡å·¥ä½¿ç”¨æ­¤è£å‚™ã€‚",
                "type": "tool"
            }
        },
        "æ¸…æ½”åŠ‘": {
            "æ¨™æº–æ¸…æ½”åŠ‘": {
                "price": 5, 
                "weight": 0.1, 
                "description": "æ¶ˆè€—å“ï¼Œæ¯ä½æ˜Ÿéš›æ¸…æ½”å·¥å…¥è·å¾Œè‡ªå‹•é…çµ¦10ç“¶ï¼Œè¼•å¾®æå‡æ¸…æ½”æ•ˆèƒ½ï¼Œé©ç”¨æ–¼å»£æ³›è¡›ç”Ÿæ¸…æ½”ã€‚",
                "type": "reagent",
                "capacity": 100
            },
            "ç‰¹æ®Šæ¸…æ½”åŠ‘": {
                "price": 20, 
                "weight": 0.1, 
                "description": "æ¶ˆè€—å“ï¼Œå°ˆç²¾æ–¼ç§»é™¤æ°£å‘³æˆ–æ·±å±¤æ»²å…¥æ€§æ±¡å¢ï¼Œé©ç”¨æ–¼ç‰¹æ®Šæ¸…æ½”é …ç›®ã€‚",
                "type": "reagent",
                "capacity": 100
            }
        },
        "é˜²è­·è£å‚™": {
            "ã€èµ·å§‹è£å‚™ã€‘æ¸…æ½”å·¥é˜²è­·æœ": {
                "price": 1, 
                "weight": 0.85, 
                "description": "æ¯ä½æ˜Ÿéš›æ¸…æ½”å·¥å…¥è·å¾Œè‡ªå‹•é…çµ¦çš„å…¥é–€ç´šé˜²è­·æœï¼Œæ˜“æ–¼æ¸…æ´—ï¼Œæ“æœ‰åŸºæœ¬ä¿æš–åŠç´ç±³ç´šledç™¼å…‰åŠŸèƒ½ã€‚",
                "type": "outfit"
            },
            "æ¸…æ½”å·¥é˜²è­·æœ-æ©Ÿå‹•æ¬¾": {
                "price": 1, 
                "weight": 3, 
                "description": "æå‡é˜²æ¯’ã€é˜²è¼»å°„ã€é˜²ç«ç­‰é˜²ç¦¦æ©Ÿèƒ½å¤–äº¦ç¢ºä¿ç”¨å®¶æ©Ÿå‹•æ€§ï¼Œé©ç”¨æ–¼Bç´šæˆ–ä»¥ä¸Šçš„æ¸…æ½”é …ç›®ã€‚",
                "type": "outfit"
            },
            "æ¸…æ½”å·¥é˜²è­·æœ-å…¨é˜²è­·æ¬¾": {
                "price": 3, 
                "weight": 5.6, 
                "description": "æ¸›å°‘æ©Ÿå‹•æ€§ä»¥æä¾›å…¨æ–¹ä½ä¿è­·ï¼Œé©ç”¨æ–¼Aç´šæˆ–ä»¥ä¸Šçš„æ¸…æ½”é …ç›®ã€‚",
                "type": "outfit"
            }
        },
        "é†«ç™‚ç”¨å“": {
            "æ€¥æ•‘åŒ…": {
                "price": 3, 
                "weight": 0.5, 
                "description": "æ¶ˆè€—å“ï¼ŒåŸºç¤é†«ç™‚åŒ…ï¼Œæ¢å¾© 30 HPã€‚",
                "heal": 30
            },
            "é†«ç™‚å™´éœ§": {
                "price": 5, 
                "weight": 0.3, 
                "description": "æ¶ˆè€—å“ï¼Œç´ç±³ä¿®å¾©å™´éœ§ï¼Œæ¢å¾© 50 HPã€‚",
                "heal": 50
            },
            "é€²éšé†«ç™‚å¥—çµ„": {
                "price": 1, 
                "weight": 1.0, 
                "description": "æ¶ˆè€—å“ï¼Œå®Œæ•´é†«ç™‚è¨­å‚™ï¼Œæ¢å¾© 100 HPã€‚",
                "heal": 100
            }
        },
        "é£Ÿç‰©": {
            "èƒ½é‡æ£’": {
                "price": 10, 
                "weight": 0.5, 
                "description": "æ¶ˆè€—å“ï¼Œæ¢å¾© 20 é«”åŠ›ã€‚", 
                "stamina": 20
            },
            "ç‡Ÿé¤Šé¤": {
                "price": 25, 
                "weight": 1, 
                "description": "æ¶ˆè€—å“ï¼Œæ¢å¾© 50 é«”åŠ›ã€‚", 
                "stamina": 50
            },
            "é«˜ç´šæ–™ç†": {
                "price": 60, 
                "weight": 1.5, 
                "description": "æ¶ˆè€—å“ï¼Œæ¢å¾© 100 é«”åŠ›ã€‚", 
                "stamina": 100
            },
            "æ˜Ÿéš›å’–å•¡": {
                "price": 15, 
                "weight": 0.3, 
                "description": "æ¶ˆè€—å“ï¼Œæ¢å¾© 30 é«”åŠ›ã€‚", 
                "stamina": 30
            }
        }
    }

# ==================== ç²å–ç‰©å“é‡é‡ ====================
def get_item_weight(item_name):
    """ç²å–ç‰©å“çš„é‡é‡"""
    items = load_items()
    
    # æª¢æŸ¥æ˜¯å¦æ˜¯å±é«”
    if "çš„å±é«”" in item_name or "è¢«åˆ‡å‰²çš„" in item_name:
        return 0
    
    # æœå°‹ç‰©å“æ•¸æ“šåº«
    for category, category_items in items.items():
        if item_name in category_items:
            return category_items[item_name].get('weight', 0)
    
    return 0

# åŠ è¼‰å ´æ™¯ç‰©å“
def load_scene_items():
    if os.path.exists(SCENE_ITEMS_FILE):
        with open(SCENE_ITEMS_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}

# ä¿å­˜å ´æ™¯ç‰©å“
def save_scene_items(items):
    with open(SCENE_ITEMS_FILE, 'w', encoding='utf-8') as f:
        json.dump(items, f, ensure_ascii=False, indent=2)

# ä»»å‹™ç³»çµ±ç›¸é—œå‡½æ•¸
def load_mission(mission_id):
    """è¼‰å…¥ä»»å‹™æ•¸æ“š"""
    filepath = os.path.join(MISSIONS_DIR, f'{mission_id}.json')
    if not os.path.exists(filepath):
        return None
    
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        print(f"è¼‰å…¥ä»»å‹™ {mission_id} å¤±æ•—: {e}")
        return None

def list_all_missions():
    """åˆ—å‡ºæ‰€æœ‰å¯ç”¨ä»»å‹™"""
    missions = []
    if not os.path.exists(MISSIONS_DIR):
        return missions
    
    for filename in os.listdir(MISSIONS_DIR):
        if filename.endswith('.json'):
            mission_id = filename[:-5]
            missions.append(mission_id)
    return missions

# ä¸‹è¼‰ä¸¦ä¿å­˜é ­åƒ
async def download_avatar(url: str, user_id: str) -> str:
    """ä¸‹è¼‰é ­åƒä¸¦ä¿å­˜åˆ°æœ¬åœ°ï¼Œè¿”å›æ–‡ä»¶è·¯å¾‘"""
    file_extension = url.split('.')[-1].split('?')[0]
    if file_extension not in ['png', 'jpg', 'jpeg', 'gif', 'webp']:
        file_extension = 'png'
    
    file_path = os.path.join(AVATARS_DIR, f"{user_id}.{file_extension}")
    
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as resp:
            if resp.status == 200:
                with open(file_path, 'wb') as f:
                    f.write(await resp.read())
                return file_path
    return None

# ç²å–é ­åƒè·¯å¾‘
def get_avatar_path(user_id: str) -> Optional[str]:
    """ç²å–ç”¨æˆ¶é ­åƒæ–‡ä»¶è·¯å¾‘"""
    for ext in ['png', 'jpg', 'jpeg', 'gif', 'webp']:
        path = os.path.join(AVATARS_DIR, f"{user_id}.{ext}")
        if os.path.exists(path):
            return path
    return None

# è¨­å®š embed footer çš„è¼”åŠ©å‡½æ•¸
def set_embed_footer(embed, ctx_or_interaction):
    """ç‚º embed è¨­å®šåŒ…å«ä¼ºæœå™¨åœ–æ¨™ã€åç¨±å’Œæ™‚é–“çš„ footer"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    if isinstance(ctx_or_interaction, discord.Interaction):
        guild = ctx_or_interaction.guild
    else:
        guild = ctx_or_interaction.guild
    
    server_name = guild.name if guild else "ç§äººè¨Šæ¯"
    icon_url = guild.icon.url if guild and guild.icon else None
    
    embed.set_footer(
        text=f"{server_name} â€¢ {timestamp}",
        icon_url=icon_url
    )
    return embed

# é«”å‹å°æ‡‰çš„åŸºç¤å±¬æ€§
BODY_TYPE_STATS = {
    "å¤§å‹ç”Ÿç‰©": {"é«”åŠ›": 120, "æ•æ·": 60, "å¹¸é‹å€¼": 70, "åŠ›é‡å€¼": 100, "è² é‡ä¸Šé™": 150, "æœ€å¤§ç”Ÿå‘½å€¼": 150, "æœ€å¤§é«”åŠ›": 120},
    "ä¸­å‹ç”Ÿç‰©": {"é«”åŠ›": 100, "æ•æ·": 80, "å¹¸é‹å€¼": 80, "åŠ›é‡å€¼": 80, "è² é‡ä¸Šé™": 100, "æœ€å¤§ç”Ÿå‘½å€¼": 120, "æœ€å¤§é«”åŠ›": 100},
    "å°å‹ç”Ÿç‰©": {"é«”åŠ›": 80, "æ•æ·": 110, "å¹¸é‹å€¼": 90, "åŠ›é‡å€¼": 60, "è² é‡ä¸Šé™": 60, "æœ€å¤§ç”Ÿå‘½å€¼": 100, "æœ€å¤§é«”åŠ›": 80}
}



# å ´æ™¯ç‰©å“å­˜å„²
channel_items = load_scene_items()

# ==================== è² å‚·ç‹€æ…‹ç³»çµ± ====================
def get_injury_status(current_hp, max_hp):
    """æ ¹æ“šç•¶å‰HPåˆ¤å®šè² å‚·ç‹€æ…‹"""
    hp_percentage = (current_hp / max_hp) * 100
    
    if hp_percentage >= 80:
        return "å¥åº·"
    elif hp_percentage >= 50:
        return "è¼•åº¦å¤–å‚·"
    elif hp_percentage >= 25:
        return "ä¸­åº¦å¤–å‚·"
    elif hp_percentage > 0:
        return "é‡åº¦å¤–å‚·"
    else:
        return "å·²æ­»äº¡"

def get_injury_color(injury_status):
    """æ ¹æ“šè² å‚·ç‹€æ…‹è¿”å›é¡è‰²emoji"""
    status_colors = {
        "å¥åº·": "ğŸŸ¢",
        "è¼•åº¦å¤–å‚·": "ğŸŸ¡",
        "ä¸­åº¦å¤–å‚·": "ğŸŸ ",
        "é‡åº¦å¤–å‚·": "ğŸ”´",
        "å·²æ­»äº¡": "ğŸ’€"
    }
    return status_colors.get(injury_status, "âšª")

# ç–²å‹ç‹€æ…‹ç³»çµ±
def get_fatigue_status(current_stamina, max_stamina):
    """æ ¹æ“šç•¶å‰é«”åŠ›åˆ¤å®šç–²å‹ç‹€æ…‹"""
    stamina_percentage = (current_stamina / max_stamina) * 100
    
    if stamina_percentage >= 80:
        return "ç²¾åŠ›å……æ²›"
    elif stamina_percentage >= 50:
        return "è¼•åº¦ç–²å‹"
    elif stamina_percentage >= 25:
        return "ä¸­åº¦ç–²å‹"
    elif stamina_percentage > 0:
        return "é‡åº¦ç–²å‹"
    else:
        return "ç²¾ç–²åŠ›ç«­"

def get_fatigue_color(fatigue_status):
    """æ ¹æ“šç–²å‹ç‹€æ…‹è¿”å›é¡è‰²emoji"""
    status_colors = {
        "ç²¾åŠ›å……æ²›": "ğŸŸ¢",
        "è¼•åº¦ç–²å‹": "ğŸŸ¡",
        "ä¸­åº¦ç–²å‹": "ğŸŸ ",
        "é‡åº¦ç–²å‹": "ğŸ”´",
        "ç²¾ç–²åŠ›ç«­": "ğŸ’€"
    }
    return status_colors.get(fatigue_status, "âšª")

def get_status_effects_display(status_effects):
    """é¡¯ç¤ºæ‰€æœ‰ç‹€æ…‹æ•ˆæœ"""
    if not status_effects:
        return "ç„¡"
    return "ã€".join(status_effects)

def add_status_effect(user_id, effect):
    """æ·»åŠ ç‹€æ…‹æ•ˆæœ"""
    data = load_data()
    if 'status_effects' not in data[user_id]:
        data[user_id]['status_effects'] = []
    
    if effect not in data[user_id]['status_effects']:
        data[user_id]['status_effects'].append(effect)
        save_data(data)

def remove_status_effect(user_id, effect):
    """ç§»é™¤ç‹€æ…‹æ•ˆæœ"""
    data = load_data()
    if 'status_effects' in data[user_id]:
        if effect in data[user_id]['status_effects']:
            data[user_id]['status_effects'].remove(effect)
            save_data(data)

def clear_status_effects(user_id):
    """æ¸…é™¤æ‰€æœ‰ç‹€æ…‹æ•ˆæœ"""
    data = load_data()
    data[user_id]['status_effects'] = []
    save_data(data)

# ==================== ç”Ÿæˆç°¡åŒ–çš„å±é«”ç·¨è™Ÿ ====================
def generate_corpse_id(channel_id):
    """ç”Ÿæˆç°¡åŒ–çš„å±é«”ç·¨è™Ÿ (C1, C2, C3...)"""
    if channel_id not in channel_items:
        channel_items[channel_id] = {}
    
    corpse_count = sum(1 for item_id in channel_items[channel_id].keys() if item_id.startswith('C'))
    return f"C{corpse_count + 1}"

# ==================== ä»»å‹™é€²åº¦æ›´æ–°å‡½æ•¸ ====================
def update_mission_progress(user_id, action_type, **kwargs):
    """æ›´æ–°ä»»å‹™é€²åº¦"""
    data = load_data()
    user_data = data[user_id]
    
    if not user_data.get('current_mission'):
        return False, None
    
    mission_id = user_data['current_mission']
    mission_data = load_mission(mission_id)
    
    if not mission_data:
        return False, None
    
    progress = user_data.get('mission_progress', {})
    current_step = progress.get('current_step', 'start')
    
    # æ ¹æ“šä¸åŒçš„è¡Œå‹•é¡å‹æ›´æ–°é€²åº¦
    if action_type == 'collect_item':
        progress['collected_items'] = progress.get('collected_items', 0) + 1
    elif action_type == 'sweep':
        progress['sweep_count'] = progress.get('sweep_count', 0) + 1
    
    # æª¢æŸ¥ç•¶å‰æ­¥é©Ÿçš„å®Œæˆæ¢ä»¶
    step_data = mission_data['steps'].get(current_step, {})
    
    if 'completion_conditions' in step_data:
        conditions = step_data['completion_conditions']
        all_met = True
        
        for condition in conditions:
            if condition['type'] == 'collect_items':
                required = condition['count']
                current = progress.get('collected_items', 0)
                if current < required:
                    all_met = False
                    break
            elif condition['type'] == 'sweep_count':
                required = condition['count']
                current = progress.get('sweep_count', 0)
                if current < required:
                    all_met = False
                    break
        
        # å¦‚æœæ‰€æœ‰æ¢ä»¶éƒ½æ»¿è¶³ï¼Œé€²å…¥ä¸‹ä¸€æ­¥
        if all_met:
            next_step = step_data.get('next_step')
            if next_step:
                if 'completed_steps' not in progress:
                    progress['completed_steps'] = []
                progress['completed_steps'].append(current_step)
                progress['current_step'] = next_step
                user_data['mission_progress'] = progress
                save_data(data)
                return True, next_step
    
    user_data['mission_progress'] = progress
    save_data(data)
    return False, None

# ==================== å‰µè§’åŠŸèƒ½ ====================
class CharacterCreationView(discord.ui.View):
    def __init__(self, user_id, ctx):
        super().__init__(timeout=300)
        self.user_id = user_id
        self.ctx = ctx
        self.character_data = {
            "name": None,
            "employee_id": None,
            "body_type": None,
            "weight": None,
            "avatar_url": None
        }
    
    @discord.ui.button(label="é€²å…¥æ¸…æ½”å·¥è¨»å†Šæµç¨‹", style=discord.ButtonStyle.primary, emoji="ğŸ§¹")
    async def start_creation(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„è¨»å†Šæµç¨‹ï¼", ephemeral=True)
            return
        
        modal = NameInputModal(self)
        await interaction.response.send_modal(modal)

class NameInputModal(discord.ui.Modal, title="è¨­å®šæ¸…æ½”å·¥è³‡è¨Š"):
    name_input = discord.ui.TextInput(
        label="æ¸…æ½”å·¥åç¨±",
        placeholder="è«‹è¼¸å…¥ä½ çš„æ¸…æ½”å·¥åç¨±",
        required=True,
        max_length=50
    )
    
    employee_id = discord.ui.TextInput(
        label="å“¡å·¥ç·¨è™Ÿ",
        placeholder="ä¾‹å¦‚: CC-00001",
        required=True,
        max_length=20
    )
    
    weight_input = discord.ui.TextInput(
        label="é«”é‡ (kg)",
        placeholder="è«‹è¼¸å…¥æ¸…æ½”å·¥é«”é‡ï¼Œä¾‹å¦‚: 70",
        required=True,
        max_length=10
    )
    
    def __init__(self, parent_view):
        super().__init__()
        self.parent_view = parent_view
    
    async def on_submit(self, interaction: discord.Interaction):
        try:
            weight = float(self.weight_input.value)
            if weight <= 0:
                await interaction.response.send_message("âŒ é«”é‡å¿…é ˆå¤§æ–¼ 0ï¼", ephemeral=True)
                return
        except ValueError:
            await interaction.response.send_message("âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„é«”é‡æ•¸å­—ï¼", ephemeral=True)
            return
        
        self.parent_view.character_data["name"] = self.name_input.value
        self.parent_view.character_data["employee_id"] = self.employee_id.value
        self.parent_view.character_data["weight"] = round_weight(weight)
        
        view = AvatarUploadView(self.parent_view)
        embed = discord.Embed(
            title="ğŸ“¸ ä¸Šå‚³æ¸…æ½”å·¥é ­åƒ",
            description="è«‹ä¸Šå‚³ä¸€å¼µåœ–ç‰‡ä½œç‚ºä½ çš„æ¸…æ½”å·¥é ­åƒã€‚\n\n"
                       "**ä¸Šå‚³æ–¹å¼ï¼š**\n"
                       "1. é»æ“Šä¸‹æ–¹ã€Œä¸Šå‚³é ­åƒã€æŒ‰éˆ•\n"
                       "2. åœ¨èŠå¤©æ¡†ä¸­ä¸Šå‚³åœ–ç‰‡ä¸¦ç™¼é€\n"
                       "3. æˆ–è€…é»æ“Šã€Œè·³éã€ä½¿ç”¨é»˜èªé ­åƒ\n\n"
                       "â±ï¸ ä½ æœ‰ 60 ç§’çš„æ™‚é–“ä¸Šå‚³é ­åƒ",
            color=discord.Color.blue()
        )
        set_embed_footer(embed, interaction)
        await interaction.response.send_message(embed=embed, view=view, ephemeral=True)

class AvatarUploadView(discord.ui.View):
    def __init__(self, parent_view):
        super().__init__(timeout=180)
        self.parent_view = parent_view
        self.waiting_for_upload = False
    
    @discord.ui.button(label="ä¸Šå‚³é ­åƒ", style=discord.ButtonStyle.primary, emoji="ğŸ“¸")
    async def upload_avatar(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.parent_view.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„è¨»å†Šæµç¨‹ï¼", ephemeral=True)
            return
        
        self.waiting_for_upload = True
        await interaction.response.send_message(
            "ğŸ“¤ è«‹åœ¨æ­¤é »é“ä¸Šå‚³ä¸€å¼µåœ–ç‰‡ï¼ˆ60ç§’å…§ï¼‰...",
            ephemeral=True
        )
        
        def check(m):
            return (m.author.id == self.parent_view.user_id and 
                   m.channel.id == interaction.channel.id and 
                   len(m.attachments) > 0)
        
        try:
            msg = await bot.wait_for('message', timeout=60.0, check=check)
            attachment = msg.attachments[0]
            
            if not any(attachment.filename.lower().endswith(ext) for ext in ['.png', '.jpg', '.jpeg', '.gif', '.webp']):
                await interaction.followup.send("âŒ è«‹ä¸Šå‚³åœ–ç‰‡æ–‡ä»¶ï¼", ephemeral=True)
                return
            
            self.parent_view.character_data["avatar_url"] = attachment.url
            avatar_path = await download_avatar(attachment.url, str(self.parent_view.user_id))
            
            if avatar_path:
                await interaction.followup.send("âœ… é ­åƒä¸Šå‚³æˆåŠŸï¼", ephemeral=True)
                await self.proceed_to_body_type(interaction)
            else:
                await interaction.followup.send("âŒ é ­åƒä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚", ephemeral=True)
        
        except asyncio.TimeoutError:
            await interaction.followup.send("â° ä¸Šå‚³è¶…æ™‚ï¼Œå°‡ä½¿ç”¨é»˜èªé ­åƒã€‚", ephemeral=True)
            await self.proceed_to_body_type(interaction)
    
    @discord.ui.button(label="è·³é", style=discord.ButtonStyle.secondary, emoji="â­ï¸")
    async def skip_avatar(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.parent_view.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„è¨»å†Šæµç¨‹ï¼", ephemeral=True)
            return
        
        self.parent_view.character_data["avatar_url"] = str(interaction.user.display_avatar.url)
        await download_avatar(self.parent_view.character_data["avatar_url"], str(self.parent_view.user_id))
        
        await interaction.response.send_message("â„¹ï¸ å°‡ä½¿ç”¨ä½ çš„ Discord é ­åƒã€‚", ephemeral=True)
        await self.proceed_to_body_type(interaction)
    
    async def proceed_to_body_type(self, interaction: discord.Interaction):
        """é€²å…¥é«”å‹é¸æ“‡éšæ®µ"""
        view = BodyTypeSelectView(self.parent_view)
        embed = discord.Embed(
            title="é¸æ“‡é«”å‹",
            description="è«‹é¸æ“‡ä½ çš„è§’è‰²é«”å‹ï¼Œé€™å°‡å½±éŸ¿ä½ çš„åŸºç¤å±¬æ€§ï¼š\n\n"
                       "ğŸ¦• **å¤§å‹ç”Ÿç‰©**: é«˜é«”åŠ›ã€é«˜åŠ›é‡ã€é«˜ç”Ÿå‘½å€¼ã€ä½æ•æ·\n"
                       "ğŸ§‘ **ä¸­å‹ç”Ÿç‰©**: å¹³è¡¡çš„å±¬æ€§åˆ†é…\n"
                       "ğŸ **å°å‹ç”Ÿç‰©**: é«˜æ•æ·ã€é«˜å¹¸é‹ã€ä½åŠ›é‡ã€ä½ç”Ÿå‘½å€¼",
            color=discord.Color.blue()
        )
        set_embed_footer(embed, interaction)
        await interaction.channel.send(embed=embed, view=view)

class BodyTypeSelectView(discord.ui.View):
    def __init__(self, parent_view):
        super().__init__(timeout=180)
        self.parent_view = parent_view
    
    @discord.ui.button(label="å¤§å‹ç”Ÿç‰©", style=discord.ButtonStyle.secondary, emoji="ğŸ¦•")
    async def large_type(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.finalize_character(interaction, "å¤§å‹ç”Ÿç‰©")
    
    @discord.ui.button(label="ä¸­å‹ç”Ÿç‰©", style=discord.ButtonStyle.secondary, emoji="ğŸ§‘")
    async def medium_type(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.finalize_character(interaction, "ä¸­å‹ç”Ÿç‰©")
    
    @discord.ui.button(label="å°å‹ç”Ÿç‰©", style=discord.ButtonStyle.secondary, emoji="ğŸ")
    async def small_type(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.finalize_character(interaction, "å°å‹ç”Ÿç‰©")
    
    async def finalize_character(self, interaction: discord.Interaction, body_type: str):
        self.parent_view.character_data["body_type"] = body_type
        
        data = load_data()
        user_id = str(interaction.user.id)
        
        stats = BODY_TYPE_STATS[body_type].copy()
        max_hp = stats["æœ€å¤§ç”Ÿå‘½å€¼"]
        max_stamina = stats["æœ€å¤§é«”åŠ›"]
        
        initial_weight = round_weight(0.6 + 1.0 + 1.0 + 2.5)
        
        data[user_id] = {
            "name": self.parent_view.character_data["name"],
            "employee_id": self.parent_view.character_data["employee_id"],
            "body_type": body_type,
            "weight": self.parent_view.character_data["weight"],
            "team": "N/A",
            "avatar_url": self.parent_view.character_data["avatar_url"],
            "stats": stats,
            "current_hp": max_hp,
            "max_hp": max_hp,
            "current_stamina": max_stamina,
            "max_stamina": max_stamina,
            "status_effects": [],
            "cp": 100,
            "inventory": {
                "æ¸…æ½”å·¥æƒæŠŠ": 1,
                "æ¨™æº–æ¸…æ½”åŠ‘": 10,
                "æ€¥æ•‘åŒ…": 2,
                "èƒ½é‡æ£’": 5
            },
            "current_weight": initial_weight,
            "current_mission": None,
            "mission_progress": {},
            "is_dead": False,
            "death_count": 0,
            "outfit": "ã€èµ·å§‹è£å‚™ã€‘æ¸…æ½”å·¥é˜²è­·æœ",
            "equipped_tool": None,
            "tool_reagents": {},
            "last_checkin_date": None,
            "checkin_streak": None,
            'last_take_food_date': None
        }
        
        save_data(data)
        
        embed = discord.Embed(
            title="âœ… æ¸…æ½”å·¥å‰µå»ºæˆåŠŸï¼",
            description=f"æ­¡è¿åŠ å…¥å¤©é«”æ¸…æƒå…¬å¸ï¼",
            color=discord.Color.green()
        )
        
        if data[user_id]["avatar_url"]:
            embed.set_thumbnail(url=data[user_id]["avatar_url"])
        
        embed.add_field(name="è§’è‰²åç¨±", value=data[user_id]["name"], inline=True)
        embed.add_field(name="å“¡å·¥ç·¨è™Ÿ", value=data[user_id]["employee_id"], inline=True)
        embed.add_field(name="é«”å‹", value=body_type, inline=True)
        embed.add_field(name="é«”é‡", value=f"{data[user_id]['weight']} kg", inline=True)
        embed.add_field(
            name="åŸºç¤å±¬æ€§",
            value=f"ã€ç”Ÿå‘½å€¼ã€‘ {max_hp}/{max_hp}\n"
                  f"ã€é«”åŠ›ã€‘{max_stamina}/{max_stamina}\n"
                  f"ã€åŠ›é‡å€¼ã€‘ {stats['åŠ›é‡å€¼']}\n"
                  f"ã€æ•æ·ã€‘ {stats['æ•æ·']}\n"
                  f"ã€å¹¸é‹å€¼ã€‘ {stats['å¹¸é‹å€¼']}\n"
                  f"ã€è² é‡ä¸Šé™ã€‘ {stats['è² é‡ä¸Šé™']}",
            inline=False
        )
        embed.add_field(name="åˆå§‹è³‡é‡‘", value=f"ğŸ’° {data[user_id]['cp']}Cp.", inline=True)
        set_embed_footer(embed, interaction)
        
        await interaction.response.edit_message(embed=embed, view=None)

@bot.command(name='start')
async def create_character(ctx):
    """é–‹å§‹å‰µå»ºè§’è‰²"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    if user_id in data:
        await ctx.send("âŒ ä½ å·²ç¶“å‰µå»ºéè§’è‰²äº†ï¼ä½¿ç”¨ `!dash` æŸ¥çœ‹è§’è‰²é¢æ¿ã€‚")
        return
    
    embed = discord.Embed(
        title="ğŸŒŒ æ­¡è¿ä¾†åˆ°å¤©é«”æ¸…æƒå…¬å¸",
        description="å…¨å®‡å®™æœ€å€¼å¾—ä¿¡è³´çš„æ¸…æ½”å…¬å¸ï¼\n\n"
                   "å¤©é«”æ¸…æƒå…¬å¸æ˜¯ä¸€é–“æ­·å²æ‚ ä¹…ã€æœå‹™é …ç›®é½Šå…¨çš„æ¸…æ½”æœå‹™å…¬å¸ã€‚\n"
                   "é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹å‰µå»ºä½ çš„æ¸…æ½”å·¥è¨»å†Šæµç¨‹ï¼",
        color=discord.Color.blue()
    )
    set_embed_footer(embed, ctx)
    
    view = CharacterCreationView(ctx.author.id, ctx)
    await ctx.send(embed=embed, view=view)

# ==================== è§’è‰²é¢æ¿ ====================
class DashboardView(discord.ui.View):
    def __init__(self, user_id, user_data, ctx):
        super().__init__(timeout=180)
        self.user_id = user_id
        self.user_data = user_data
        self.ctx = ctx
    
    @discord.ui.button(label="å±¬æ€§", style=discord.ButtonStyle.primary, emoji="ğŸ“Š")
    async def view_stats(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„é¢æ¿ï¼", ephemeral=True)
            return
        
        hp_percent = (self.user_data['current_hp'] / self.user_data['max_hp']) * 100
        if hp_percent > 66:
            color = discord.Color.green()
        elif hp_percent > 33:
            color = discord.Color.gold()
        else:
            color = discord.Color.red()
        
        embed = discord.Embed(title=f"ğŸ“Š {self.user_data['name']} çš„å±¬æ€§", color=color)
        stats = self.user_data['stats']
        embed.add_field(
            name="åŸºç¤å±¬æ€§",
            value=f"ã€ç”Ÿå‘½å€¼ã€‘{self.user_data['current_hp']}/{self.user_data['max_hp']}\n"
                  f"ã€é«”åŠ›ã€‘ {self.user_data['current_stamina']}/{self.user_data['max_stamina']}\n"
                  f"ã€åŠ›é‡å€¼ã€‘ {stats['åŠ›é‡å€¼']}\n"
                  f"ã€æ•æ·ã€‘ {stats['æ•æ·']}\n"
                  f"ã€å¹¸é‹å€¼ã€‘ {stats['å¹¸é‹å€¼']}\n"
                  f"ã€è² é‡ä¸Šé™ã€‘ {stats['è² é‡ä¸Šé™']}",
            inline=False
        )
        
        if self.user_data.get("avatar_url"):
            embed.set_thumbnail(url=self.user_data["avatar_url"])
        
        set_embed_footer(embed, interaction)
        await interaction.response.send_message(embed=embed, ephemeral=True)
    
    @discord.ui.button(label="ç‰©å“æ¬„", style=discord.ButtonStyle.secondary, emoji="ğŸ’")
    async def view_inventory(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„é¢æ¿ï¼", ephemeral=True)
            return
        
        embed = discord.Embed(title=f"ğŸ’ ç‰©å“æ¬„", color=discord.Color.gold())
        inventory_text = ""
        
        if not self.user_data['inventory']:
            inventory_text = "ç©ºç©ºå¦‚ä¹Ÿ..."
        else:
            for item, quantity in self.user_data['inventory'].items():
                inventory_text += f"â€¢ {item} x{quantity}\n"
        
        embed.add_field(name="æŒæœ‰ç‰©å“", value=inventory_text, inline=False)
        embed.add_field(
            name="è² é‡",
            value=f"{round_weight(self.user_data['current_weight'])}/{self.user_data['stats']['è² é‡ä¸Šé™']} kg",
            inline=False
        )
        set_embed_footer(embed, interaction)
        
        await interaction.response.send_message(embed=embed, ephemeral=True)
    
    @discord.ui.button(label="æ›´è¡£", style=discord.ButtonStyle.secondary, emoji="ğŸ‘”")
    async def change_outfit(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„é¢æ¿ï¼", ephemeral=True)
            return
        
        embed = discord.Embed(
            title="ğŸ‘” æ›´è¡£å®¤",
            description=f"ç•¶å‰æœè£: {self.user_data['outfit']}\n\n"
                       "æç¤ºï¼šå“¡å·¥éœ€éš¨æ™‚ç©¿è‘—å¸¶æœ‰å…¬å¸åœ–ç¤ºçš„åˆè¦æ ¼åˆ¶æœã€‚",
            color=discord.Color.purple()
        )
        set_embed_footer(embed, interaction)
        await interaction.response.send_message(embed=embed, ephemeral=True)
    
    @discord.ui.button(label="æ›´æ›é ­åƒ", style=discord.ButtonStyle.secondary, emoji="ğŸ“¸")
    async def change_avatar(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„é¢æ¿ï¼", ephemeral=True)
            return
        
        await interaction.response.send_message(
            "ğŸ“¤ è«‹åœ¨æ­¤é »é“ä¸Šå‚³ä¸€å¼µæ–°çš„é ­åƒåœ–ç‰‡ï¼ˆ60ç§’å…§ï¼‰...",
            ephemeral=True
        )
        
        def check(m):
            return (m.author.id == self.user_id and 
                   m.channel.id == interaction.channel.id and 
                   len(m.attachments) > 0)
        
        try:
            msg = await bot.wait_for('message', timeout=60.0, check=check)
            attachment = msg.attachments[0]
            
            if not any(attachment.filename.lower().endswith(ext) for ext in ['.png', '.jpg', '.jpeg', '.gif', '.webp']):
                await interaction.followup.send("âŒ è«‹ä¸Šå‚³åœ–ç‰‡æ–‡ä»¶ï¼", ephemeral=True)
                return
            
            avatar_path = await download_avatar(attachment.url, str(self.user_id))
            
            if avatar_path:
                data = load_data()
                data[str(self.user_id)]["avatar_url"] = attachment.url
                save_data(data)
                
                await interaction.followup.send("âœ… é ­åƒæ›´æ–°æˆåŠŸï¼ä½¿ç”¨ `!dash` æŸ¥çœ‹æ–°é ­åƒã€‚", ephemeral=True)
            else:
                await interaction.followup.send("âŒ é ­åƒä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚", ephemeral=True)
        
        except asyncio.TimeoutError:
            await interaction.followup.send("â° ä¸Šå‚³è¶…æ™‚ã€‚", ephemeral=True)

@bot.command(name='dash')
async def dashboard(ctx):
    """æŸ¥çœ‹è§’è‰²é¢æ¿ï¼ˆæ­»äº¡ç‹€æ…‹ä¹Ÿå¯æŸ¥çœ‹ï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    if user_id not in data:
        await ctx.send("âŒ ä½ é‚„æ²’æœ‰å‰µå»ºè§’è‰²ï¼ä½¿ç”¨ `!start` é–‹å§‹å‰µå»ºã€‚")
        return
    
    user_data = data[user_id]
    
    if 'status_effects' not in user_data:
        user_data['status_effects'] = []
    if 'current_stamina' not in user_data:
        user_data['current_stamina'] = user_data['stats'].get('æœ€å¤§é«”åŠ›', 100)
        user_data['max_stamina'] = user_data['stats'].get('æœ€å¤§é«”åŠ›', 100)
    if 'team' not in user_data:
        user_data['team'] = "N/A"
    if 'equipped_tool' not in user_data:
        user_data['equipped_tool'] = None
    if 'tool_reagents' not in user_data:
        user_data['tool_reagents'] = {}
    
    user_data['current_weight'] = round_weight(user_data.get('current_weight', 0))
    
    save_data(data)
    
    injury_status = get_injury_status(user_data['current_hp'], user_data['max_hp'])
    injury_color_emoji = get_injury_color(injury_status)
    
    fatigue_status = get_fatigue_status(user_data['current_stamina'], user_data['max_stamina'])
    fatigue_color_emoji = get_fatigue_color(fatigue_status)
    
    if user_data.get('is_dead', False):
        color = discord.Color.dark_red()
    else:
        hp_percent = (user_data['current_hp'] / user_data['max_hp']) * 100
        if hp_percent > 66:
            color = discord.Color.green()
        elif hp_percent > 33:
            color = discord.Color.gold()
        else:
            color = discord.Color.red()
    
    status_effects_display = get_status_effects_display(user_data['status_effects'])
    
    embed = discord.Embed(
        title=f"{user_data['name']} çš„è§’è‰²é¢æ¿",
        color=color
    )
    
    if user_data.get("avatar_url"):
        embed.set_thumbnail(url=user_data["avatar_url"])
    
    tool_info = "ç„¡"
    if user_data.get('equipped_tool'):
        tool_name = user_data['equipped_tool']
        tool_info = f"{tool_name}"
        
        items = load_items()
        tool_reagent_capacity = None
        
        for category, category_items in items.items():
            if tool_name in category_items:
                if "reagents" in category_items[tool_name]:
                    tool_reagent_capacity = category_items[tool_name]["reagents"]
                    break
        
        if tool_reagent_capacity:
            reagents = user_data.get('tool_reagents', {})
            reagent_lines = []
            for reagent_type, max_capacity in tool_reagent_capacity.items():
                current = reagents.get(reagent_type, 0)
                reagent_lines.append(f"  â”” {reagent_type}: {current}/{max_capacity}")
            
            tool_info += "\n" + "\n".join(reagent_lines)
    
    death_status = ""
    if user_data.get('is_dead', False):
        death_status = "\n\nğŸ’€ **[å·²æ­»äº¡]** ç­‰å¾…ä»»å‹™å®Œæˆå¾Œå•Ÿå‹•ç”Ÿç‰©æ‰“å°"
    
    info_text = (
        f"ã€ç”Ÿå‘½å€¼ã€‘ {user_data['current_hp']}/{user_data['max_hp']}\n"
        f"ã€é«”åŠ›ã€‘ {user_data['current_stamina']}/{user_data['max_stamina']}\n"
        f"ã€å“¡å·¥ç·¨è™Ÿã€‘ {user_data['employee_id']}\n"
        f"ã€é«”å‹ã€‘ {user_data['body_type']}\n"
        f"ã€è² å‚·ç‹€æ…‹ã€‘ {injury_color_emoji} {injury_status}\n"
        f"ã€ç–²å‹ç‹€æ…‹ã€‘ {fatigue_color_emoji} {fatigue_status}\n"
        f"ã€ç‹€æ…‹æ•ˆæœã€‘ {status_effects_display}\n"
        f"ã€Cp.ã€‘ {user_data['cp']}<a:spinning_coin:1350848007167545404>"
        f"{death_status}"
    )
    
    embed.description = info_text
    
    embed.add_field(
        name="ğŸ‘¥ æ‰€å±¬å°éšŠ",
        value=user_data.get('team', 'N/A'),
        inline=False
    )
    
    embed.add_field(
        name="ğŸ”§ æ‰‹æŒå·¥å…·",
        value=tool_info,
        inline=False
    )
    
    embed.add_field(
        name="ğŸ“‹ ç•¶å‰ä»»å‹™",
        value=user_data['current_mission'] or "ç„¡",
        inline=False
    )
    
    embed.add_field(name="â˜ ï¸ æ­»äº¡æ¬¡æ•¸", value=user_data['death_count'], inline=True)
    
    set_embed_footer(embed, ctx)
    
    view = DashboardView(ctx.author.id, user_data, ctx)
    await ctx.send(embed=embed, view=view)

# ==================== æ‰‹æŒå·¥å…·ç³»çµ± ====================
@bot.command(name='equip')
@check_alive
async def equip_tool(ctx, *, tool_name: str = None):
    """è£å‚™å·¥å…·åˆ°æ‰‹æŒæ¬„ä½"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if not tool_name:
        if user_data.get('equipped_tool'):
            old_tool = user_data['equipped_tool']
            user_data['equipped_tool'] = None
            save_data(data)
            await ctx.send(f"âœ… å·²è§£é™¤è£å‚™ `{old_tool}`ã€‚")
        else:
            await ctx.send("â„¹ï¸ ä½ ç•¶å‰æ²’æœ‰è£å‚™ä»»ä½•å·¥å…·ã€‚")
        return
    
    if tool_name not in user_data['inventory'] or user_data['inventory'][tool_name] <= 0:
        await ctx.send(f"âŒ ä½ çš„ç‰©å“æ¬„ä¸­æ²’æœ‰ `{tool_name}`ã€‚")
        return
    
    items = load_items()
    is_tool = False
    tool_data = None
    
    for category, category_items in items.items():
        if tool_name in category_items:
            if category_items[tool_name].get("type") == "tool":
                is_tool = True
                tool_data = category_items[tool_name]
                break
    
    if not is_tool:
        await ctx.send(f"âŒ `{tool_name}` ä¸æ˜¯å·¥å…·é¡ç‰©å“ï¼")
        return
    
    if user_data.get('equipped_tool'):
        await ctx.send(f"â„¹ï¸ ä½ å·²ç¶“è£å‚™äº† `{user_data['equipped_tool']}`ï¼Œå°‡æ›¿æ›ç‚º `{tool_name}`ã€‚")
    
    user_data['equipped_tool'] = tool_name
    
    if 'tool_reagents' not in user_data:
        user_data['tool_reagents'] = {}
    
    if "reagents" in tool_data:
        for reagent_type, capacity in tool_data["reagents"].items():
            if reagent_type not in user_data['tool_reagents']:
                user_data['tool_reagents'][reagent_type] = 0
        
        save_data(data)
        
        reagent_lines = []
        for reagent_type, capacity in tool_data["reagents"].items():
            current = user_data['tool_reagents'].get(reagent_type, 0)
            reagent_lines.append(f"{reagent_type}: {current}/{capacity}")
        
        reagent_display = "\n".join(reagent_lines)
        
        await ctx.send(
            f"âœ… å·²è£å‚™ `{tool_name}` åˆ°æ‰‹æŒæ¬„ä½ã€‚\n"
            f"ğŸ“Š æ¸…æ½”åŠ‘ç‹€æ…‹:\n```\n{reagent_display}\n```"
            f"ğŸ’¡ ä½¿ç”¨ `!refill [æ¸…æ½”åŠ‘é¡å‹]` ä¾†æ³¨æ»¿æ¸…æ½”åŠ‘ã€‚"
        )
    else:
        save_data(data)
        await ctx.send(f"âœ… å·²è£å‚™ `{tool_name}` åˆ°æ‰‹æŒæ¬„ä½ã€‚")

@bot.command(name='refill')
@check_alive
async def refill_reagent(ctx, *, reagent_name: str = "æ¨™æº–æ¸…æ½”åŠ‘"):
    """é‡æ–°æ³¨æ»¿æ¸…æ½”åŠ‘"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if reagent_name not in user_data['inventory'] or user_data['inventory'][reagent_name] <= 0:
        await ctx.send(f"âŒ ä½ çš„ç‰©å“æ¬„ä¸­æ²’æœ‰ `{reagent_name}`ã€‚")
        return
    
    if not user_data.get('equipped_tool'):
        await ctx.send("âŒ ä½ éœ€è¦å…ˆè£å‚™æ¸…æ½”å·¥å…·æ‰èƒ½æ³¨æ»¿æ¸…æ½”åŠ‘ï¼")
        return
    
    items = load_items()
    tool_name = user_data['equipped_tool']
    tool_reagent_capacity = None
    
    for category, category_items in items.items():
        if tool_name in category_items:
            if "reagents" in category_items[tool_name]:
                tool_reagent_capacity = category_items[tool_name]["reagents"]
                break
    
    if not tool_reagent_capacity:
        await ctx.send(f"âŒ `{tool_name}` ä¸æ”¯æ´æ¸…æ½”åŠ‘ç³»çµ±ï¼")
        return
    
    if reagent_name not in tool_reagent_capacity:
        await ctx.send(f"âŒ `{tool_name}` ä¸æ”¯æ´ `{reagent_name}`ï¼")
        return
    
    if 'tool_reagents' not in user_data:
        user_data['tool_reagents'] = {}
    
    max_capacity = tool_reagent_capacity[reagent_name]
    
    if user_data['tool_reagents'].get(reagent_name, 0) >= max_capacity:
        await ctx.send(f"â„¹ï¸ {reagent_name} å·²ç¶“æ˜¯æ»¿çš„äº†ï¼ï¼ˆ{max_capacity}/{max_capacity}ï¼‰")
        return
    
    user_data['tool_reagents'][reagent_name] = max_capacity
    user_data['inventory'][reagent_name] -= 1
    
    if user_data['inventory'][reagent_name] <= 0:
        del user_data['inventory'][reagent_name]
    
    save_data(data)
    
    await ctx.send(f"âœ… å·²ç‚º `{tool_name}` æ³¨æ»¿ `{reagent_name}`ï¼({max_capacity}/{max_capacity})\nğŸ’¡ ä½¿ç”¨ `!use {tool_name}` é€²è¡Œæ¸…æ½”ã€‚")

# ==================== ä½¿ç”¨ç‰©å“ç³»çµ±ï¼ˆæ–°å¢ä»»å‹™é€²åº¦è¿½è¹¤ï¼‰====================
@bot.command(name='use')
@check_alive
async def use_item(ctx, *, item_name: str = None):
    """ä½¿ç”¨ç‰©å“ï¼ˆåŒ…å«æ¸…æ½”å·¥å…·çš„ä»»å‹™é€²åº¦è¿½è¹¤ï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if not item_name:
        # å¦‚æœæ²’æœ‰æŒ‡å®šç‰©å“ï¼Œä½¿ç”¨æ‰‹æŒå·¥å…·
        if user_data.get('equipped_tool'):
            item_name = user_data['equipped_tool']
        else:
            await ctx.send("âŒ è«‹æŒ‡å®šè¦ä½¿ç”¨çš„ç‰©å“ï¼Œæˆ–å…ˆè£å‚™å·¥å…·ã€‚")
            return
    
    # æª¢æŸ¥æ˜¯å¦æ˜¯æ‰‹æŒçš„æ¸…æ½”å·¥å…·
    if item_name == user_data.get('equipped_tool'):
        items = load_items()
        tool_reagent_capacity = None
        
        for category, category_items in items.items():
            if item_name in category_items:
                if "reagents" in category_items[item_name]:
                    tool_reagent_capacity = category_items[item_name]["reagents"]
                    break
        
        # ä½¿ç”¨æ”¯æ´æ¸…æ½”åŠ‘çš„å·¥å…·
        if tool_reagent_capacity:
            if 'tool_reagents' not in user_data:
                user_data['tool_reagents'] = {}
            
            # æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„æ¸…æ½”åŠ‘
            if user_data['tool_reagents'].get('æ¨™æº–æ¸…æ½”åŠ‘', 0) < 10:
                await ctx.send(f"âŒ æ¨™æº–æ¸…æ½”åŠ‘ä¸è¶³ï¼ˆéœ€è¦10é»ï¼‰ï¼\nğŸ’¡ ä½¿ç”¨ `!refill æ¨™æº–æ¸…æ½”åŠ‘` æ³¨æ»¿ã€‚")
                return
            
            user_data['tool_reagents']['æ¨™æº–æ¸…æ½”åŠ‘'] -= 10
            max_capacity = tool_reagent_capacity.get('æ¨™æº–æ¸…æ½”åŠ‘', 100)
            save_data(data)
            
            # âœ¨ æª¢æŸ¥æ˜¯å¦åœ¨ä»»å‹™ä¸­ï¼Œä¸¦æ›´æ–°æ¸…æ½”é€²åº¦
            mission_updated = False
            next_step_name = None
            
            if user_data.get('current_mission'):
                result = update_mission_progress(user_id, 'sweep')
                if result:
                    mission_updated, next_step_name = result
            
            base_message = f"ğŸ§¹ ä½¿ç”¨ `{item_name}` é€²è¡Œæ¸…æ½”ï¼\nå‰©é¤˜æ¨™æº–æ¸…æ½”åŠ‘: {user_data['tool_reagents']['æ¨™æº–æ¸…æ½”åŠ‘']}/{max_capacity}"
            
            if mission_updated and next_step_name:
                mission_data = load_mission(user_data['current_mission'])
                next_step_data = mission_data['steps'].get(next_step_name, {})
                next_step_desc = next_step_data.get('description', 'ç¹¼çºŒä»»å‹™')
                
                # æ›¿æ›è®Šæ•¸
                progress = user_data.get('mission_progress', {})
                next_step_desc = next_step_desc.replace('{collected_items}', str(progress.get('collected_items', 0)))
                next_step_desc = next_step_desc.replace('{sweep_count}', str(progress.get('sweep_count', 0)))
                
                embed = discord.Embed(
                    title="ğŸ“‹ ä»»å‹™é€²åº¦æ›´æ–°ï¼",
                    description=base_message,
                    color=discord.Color.green()
                )
                embed.add_field(
                    name="âœ¨ éšæ®µå®Œæˆ",
                    value=f"é€²å…¥ä¸‹ä¸€éšæ®µ: **{next_step_name}**",
                    inline=False
                )
                embed.add_field(
                    name="ğŸ“ ä¸‹ä¸€æ­¥",
                    value=next_step_desc,
                    inline=False
                )
                set_embed_footer(embed, ctx)
                await ctx.send(embed=embed)
            else:
                await ctx.send(base_message)
            
            return
    
    # å…¶ä»–ç‰©å“ä½¿ç”¨é‚è¼¯
    if item_name not in user_data['inventory'] or user_data['inventory'][item_name] <= 0:
        await ctx.send(f"âŒ ä½ çš„ç‰©å“æ¬„ä¸­æ²’æœ‰ `{item_name}`ã€‚")
        return
    
    await ctx.send(f"ğŸ”§ ä½ ä½¿ç”¨äº† `{item_name}`ã€‚")

# ==================== å¤§å‹ç‰©å“åˆ†è§£æ§ ====================
@bot.command(name='cut')
@check_alive
async def cut_item(ctx, item_id: str):
    """ä½¿ç”¨å¤§å‹ç‰©å“åˆ†è§£æ§åˆ‡å‰²å ´æ™¯ç‰©å“"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if user_data.get('equipped_tool') != "å¤§å‹ç‰©ä»¶åˆ†è§£æ§":
        await ctx.send("âŒ ä½ éœ€è¦æ‰‹æŒ `å¤§å‹ç‰©ä»¶åˆ†è§£æ§` æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼\nğŸ’¡ ä½¿ç”¨ `!equip å¤§å‹ç‰©ä»¶åˆ†è§£æ§` ä¾†è£å‚™ã€‚")
        return
    
    channel_id = str(ctx.channel.id)
    
    if channel_id not in channel_items or item_id not in channel_items[channel_id]:
        await ctx.send(f"âŒ æ‰¾ä¸åˆ°ç‰©å“ç·¨è™Ÿ `{item_id}`ã€‚ä½¿ç”¨ `!check` æŸ¥çœ‹å ´æ™¯ç‰©å“ã€‚")
        return
    
    item_info = channel_items[channel_id][item_id]
    original_name = item_info['name']
    
    if "è¢«åˆ‡å‰²çš„" in original_name:
        await ctx.send(f"âŒ `{original_name}` å·²ç¶“è¢«åˆ‡å‰²éäº†ï¼")
        return
    
    stamina_cost = 30
    if user_data['current_stamina'] < stamina_cost:
        await ctx.send(f"âŒ é«”åŠ›ä¸è¶³ï¼éœ€è¦ {stamina_cost} é«”åŠ›ã€‚\nğŸ’¡ ä½¿ç”¨ `!eat [é£Ÿç‰©]` æ¢å¾©é«”åŠ›ã€‚")
        return
    
    user_data['current_stamina'] -= stamina_cost
    
    original_weight = item_info.get('weight', 0)
    
    del channel_items[channel_id][item_id]
    
    cut_name = f"è¢«åˆ‡å‰²çš„{original_name}"
    cut_weight = round_weight(original_weight / 2) if original_weight > 0 else 0
    
    for i in range(2):
        new_item_id = f"ITEM_{len(channel_items[channel_id]) + 1}"
        channel_items[channel_id][new_item_id] = {
            "name": cut_name,
            "weight": cut_weight,
            "placed_by": ctx.author.display_name
        }
    
    save_data(data)
    save_scene_items(channel_items)
    
    embed = discord.Embed(
        title="âœ‚ï¸ ç‰©å“åˆ‡å‰²æˆåŠŸï¼",
        description=f"ä½¿ç”¨å¤§å‹ç‰©å“åˆ†è§£æ§å°‡ `{original_name}` åˆ‡å‰²æˆå…©åŠï¼",
        color=discord.Color.blue()
    )
    embed.add_field(name="æ¶ˆè€—é«”åŠ›", value=f"-{stamina_cost} âš¡", inline=True)
    embed.add_field(name="ç•¶å‰é«”åŠ›", value=f"{user_data['current_stamina']}/{user_data['max_stamina']}", inline=True)
    embed.add_field(
        name="ç”Ÿæˆç‰©å“", 
        value=f"2x `{cut_name}` (å„ {cut_weight} kg)" if cut_weight > 0 else f"2x `{cut_name}`", 
        inline=False
    )
    
    set_embed_footer(embed, ctx)
    await ctx.send(embed=embed)

# ===================== è½‰è³¬ ======================    
@bot.command(name='transfer')
async def transfer_money(ctx, target: discord.Member, transfer_amount: int):
    "é€²è¡Œè½‰è³¬"
    data = load_data()
    user_id = str(ctx.author.id)
    user_data = data[user_id]
    target_id = str(target.id)

    # æª¢æŸ¥ç›®æ¨™æ˜¯å¦å·²å‰µå»ºè§’è‰²
    if target_id not in data:
        await ctx.send(f"âŒ {target.mention} é‚„æ²’æœ‰å‰µå»ºè§’è‰²ï¼")
        return
    
    target_data = data[target_id]
    
    # âœ… æª¢æŸ¥æ˜¯å¦è½‰è³¬çµ¦è‡ªå·±
    if user_id == target_id:
        await ctx.send("âŒ ä½ ä¸èƒ½è½‰è³¬çµ¦è‡ªå·±ï¼")
        return
    
    # âœ… æª¢æŸ¥è½‰è³¬é‡‘é¡æ˜¯å¦ç‚ºæ­£æ•¸
    if transfer_amount <= 0:
        await ctx.send("âŒ è½‰è³¬é‡‘é¡å¿…é ˆå¤§æ–¼ 0ï¼")
        return
    
    # æª¢æŸ¥ Cp. æ˜¯å¦è¶³å¤ 
    if user_data['cp'] < transfer_amount:  # âš ï¸ ä¸è¦ç”¨ .get()ï¼Œç›´æ¥è¨ªå•
        await ctx.send(f"âŒ ä½ çš„ Cp. ä¸å¤ ï¼ç›®å‰åªæœ‰ {user_data['cp']} Cp.")
        return  # âš ï¸ åŠ ä¸Š returnï¼Œå¦å‰‡æœƒç¹¼çºŒåŸ·è¡Œ
    
    # âš ï¸ åŸ·è¡Œè½‰è³¬ï¼ˆä¸è¦ç”¨ .get()ï¼Œè¦ç›´æ¥ä¿®æ”¹ï¼‰
    user_data['cp'] -= transfer_amount
    target_data['cp'] += transfer_amount
    
    # å‰µå»ºæˆåŠŸè¨Šæ¯
    embed = discord.Embed(
        title="ğŸ’¸ è½‰è³¬æˆåŠŸï¼",
        description=f"{ctx.author.mention} æˆåŠŸè½‰è³¬ **{transfer_amount}** Cp.<a:spinning_coin:1350848007167545404> çµ¦ {target.mention}ï¼",
        color=discord.Colour.green()
    )
    embed.add_field(
        name="å‰©é¤˜ Cp.", 
        value=f"{user_data['cp']} Cp.<a:spinning_coin:1350848007167545404>", 
        inline=True
    )
    embed.add_field(
        name="å°æ–¹çš„ Cp.", 
        value=f"{target_data['cp']} Cp.<a:spinning_coin:1350848007167545404>", 
        inline=True
    )
    
    save_data(data)
    set_embed_footer(embed, ctx)
    await ctx.send(embed=embed)


# ================== æ”»æ“Šå…¶ä»–ç©å®¶ ==================
@bot.command(name='attack')
@check_alive
async def make_damage(ctx, target: discord.Member): 
    """æ”»æ“Šå…¶ä»–ç©å®¶"""
    data = load_data()
    user_id = str(ctx.author.id)
    user_data = data[user_id]
    target_id = str(target.id)  
    
    if target_id not in data:
        await ctx.send(f"âŒ {target.mention} é‚„æ²’æœ‰å‰µå»ºè§’è‰²ï¼")
        return
    
    target_data = data[target_id]
    
    if user_data.get('equipped_tool') is None: 
        await ctx.send("âŒ ä½ éœ€è¦æ‰‹æŒ `æ¸…æ½”è¨­å‚™` æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼\nğŸ’¡ ä½¿ç”¨ `!equip ï¼ˆæ¸…æ½”è¨­å‚™åç¨±ï¼‰` ä¾†è£å‚™ã€‚")
        return
    
    if target_data.get('is_dead', False):
        await ctx.send(f"ğŸ’€ {target.mention} å·²ç¶“æ­»äº¡ï¼ä½ ç„¡æ³•ç™¼èµ·æ”»æ“Š...")
        return
    
    if user_id == target_id:
        await ctx.send("âŒ ä½ ä¸èƒ½æ”»æ“Šè‡ªå·±ï¼")
        return
    
    # âœ… åŸºç¤å‚·å®³ï¼ˆæ ¹æ“šæ­¦å™¨ï¼‰
    weapon = user_data.get('equipped_tool', 'å¾’æ‰‹')
    weapon_damage = {
        'æ¸…æ½”å·¥æƒæŠŠ': 20,
        'æ¸…æ½”å·¥æƒæŠŠpro': 30,
        'å¤§å‹ç‰©ä»¶åˆ†è§£æ§': 50,
        'å¾’æ‰‹': 10
    }.get(weapon, 15)
    
    # âœ… è¨ˆç®—åŠ›é‡åŠ æˆ
    damage_info = calculate_attack_damage(user_data, weapon_damage)
    final_damage = damage_info['final_damage']
    
    # æ‰£è¡€
    target_data['current_hp'] -= final_damage
    
    # æª¢æŸ¥æ­»äº¡
    if target_data['current_hp'] <= 0:
        target_data['current_hp'] = 0
        target_data['is_dead'] = True
        target_data['death_count'] = target_data.get('death_count', 0) + 1
        
        # ç”Ÿæˆå±é«”
        channel_id = str(ctx.channel.id)
        if channel_id not in channel_items:
            channel_items[channel_id] = {}
        
        corpse_id = generate_corpse_id(channel_id)
        corpse_weight = round_weight(target_data.get('weight', 70))
        
        channel_items[channel_id][corpse_id] = {
            "name": f"{target_data['name']}çš„å±é«”",
            "type": "corpse",
            "weight": corpse_weight,
            "owner_id": target_id,
            "placed_by": ctx.author.display_name
        }
        
        save_scene_items(channel_items)
        
        embed = discord.Embed(
            title="ğŸ’€ æ“Šæ®ºæˆåŠŸï¼",
            description=f"{ctx.author.mention} æ“Šæ®ºäº† {target.mention}ï¼",
            color=discord.Color.red()
        )
        embed.add_field(name="é€ æˆå‚·å®³", value=f"{final_damage} HP", inline=True)
        embed.add_field(name="ä½¿ç”¨æ­¦å™¨", value=weapon, inline=True)
        embed.add_field(
            name="å‚·å®³è¨ˆç®—",
            value=f"åŸºç¤å‚·å®³: {damage_info['base_damage']}\n"
                  f"åŠ›é‡åŠ æˆ: {damage_info['bonus']:+d}\n"
                  f"æœ€çµ‚å‚·å®³: **{final_damage}**",
            inline=False
        )
        embed.add_field(name="â˜ ï¸ å±é«”ç·¨è™Ÿ", value=corpse_id, inline=True)
    else:
        embed = discord.Embed(
            title="âš”ï¸ æ”»æ“ŠæˆåŠŸï¼",
            description=f"{ctx.author.mention} å° {target.mention} é€ æˆäº†å‚·å®³ï¼",
            color=discord.Color.orange()
        )
        embed.add_field(name="é€ æˆå‚·å®³", value=f"{final_damage} HP", inline=True)
        embed.add_field(name="å‰©é¤˜ HP", value=f"{target_data['current_hp']}/{target_data['max_hp']}", inline=True)
        embed.add_field(name="ä½¿ç”¨æ­¦å™¨", value=weapon, inline=True)
        embed.add_field(
            name="å‚·å®³è¨ˆç®—",
            value=f"åŸºç¤å‚·å®³: {damage_info['base_damage']}\n"
                  f"åŠ›é‡åŠ æˆ: {damage_info['bonus']:+d}\n"
                  f"æœ€çµ‚å‚·å®³: **{final_damage}**",
            inline=False
        )
    
    save_data(data)
    set_embed_footer(embed, ctx)
    await ctx.send(embed=embed)

# ==================== æ­»äº¡ç³»çµ± ====================
@bot.command(name='damage')
async def take_damage(ctx, amount: int):
    """å—åˆ°å‚·å®³ï¼ˆæ¸¬è©¦ç”¨ï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    if user_id not in data:
        await ctx.send("âŒ ä½ é‚„æ²’æœ‰å‰µå»ºè§’è‰²ï¼")
        return
    
    user_data = data[user_id]
    
    if user_data.get('is_dead', False):
        await ctx.send("ğŸ’€ ä½ å·²ç¶“æ­»äº¡ï¼ç­‰å¾…ä»»å‹™å®Œæˆå¾Œå•Ÿå‹•ç”Ÿç‰©æ‰“å°...")
        return
    
    if amount <= 0:
        await ctx.send("âŒ å‚·å®³å€¼å¿…é ˆå¤§æ–¼ 0ï¼")
        return
    
    old_hp = user_data['current_hp']
    user_data['current_hp'] = max(0, user_data['current_hp'] - amount)
    
    if user_data['current_hp'] <= 0:
        user_data['death_count'] += 1
        user_data['is_dead'] = True
        
        channel_id = str(ctx.channel.id)
        if channel_id not in channel_items:
            channel_items[channel_id] = {}
        
        corpse_id = generate_corpse_id(channel_id)
        
        corpse_weight = round_weight(user_data.get('weight', 70))
        
        channel_items[channel_id][corpse_id] = {
            "name": f"{user_data['name']}çš„å±é«”",
            "type": "corpse",
            "weight": corpse_weight,
            "owner_id": user_id,
            "placed_by": "ç³»çµ±"
        }
        
        save_data(data)
        save_scene_items(channel_items)
        
        embed = discord.Embed(
            title="ğŸ’€ ä½ æ­»äº†ï¼",
            description=f"å—åˆ°äº† {amount} é»å‚·å®³\n\n"
                       f"ä½ çš„å±é«”å·²æ‰è½åœ¨æ­¤å ´æ™¯ï¼ˆç‰©å“ç·¨è™Ÿ: `{corpse_id}`ï¼‰\n"
                       f"è² é‡: {corpse_weight} kg\n\n"
                       f"âš ï¸ åœ¨ä»»å‹™å®Œæˆå‰ç„¡æ³•å•Ÿå‹•ç”Ÿç‰©æ‰“å°ï¼\n"
                       f"âš ï¸ æ­»äº¡æœŸé–“ç„¡æ³•é€²è¡Œä»»ä½•è¡Œå‹•ï¼",
            color=discord.Color.dark_red()
        )
        embed.add_field(name="æ­»äº¡æ¬¡æ•¸", value=f"â˜ ï¸ {user_data['death_count']}", inline=True)
        set_embed_footer(embed, ctx)
        
        await ctx.send(embed=embed)
    else:
        save_data(data)
        
        hp_percent = (user_data['current_hp'] / user_data['max_hp']) * 100
        if hp_percent > 66:
            color = discord.Color.green()
        elif hp_percent > 33:
            color = discord.Color.gold()
        else:
            color = discord.Color.red()
        
        embed = discord.Embed(
            title="ğŸ’” å—åˆ°å‚·å®³ï¼",
            description=f"å—åˆ°äº† {amount} é»å‚·å®³",
            color=color
        )
        embed.add_field(name="ç•¶å‰ç”Ÿå‘½å€¼", value=f"â¤ï¸ {user_data['current_hp']}/{user_data['max_hp']}", inline=True)
        
        injury_status = get_injury_status(user_data['current_hp'], user_data['max_hp'])
        injury_color_emoji = get_injury_color(injury_status)
        embed.add_field(name="è² å‚·ç‹€æ…‹", value=f"{injury_color_emoji} {injury_status}", inline=True)
        
        set_embed_footer(embed, ctx)
        
        await ctx.send(embed=embed)

@bot.command(name='print')
async def manual_print(ctx):
    """æ‰‹å‹•å•Ÿå‹•ç”Ÿç‰©æ‰“å°ï¼ˆä»»å‹™å®Œæˆå¾Œï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    if user_id not in data:
        await ctx.send("âŒ ä½ é‚„æ²’æœ‰å‰µå»ºè§’è‰²ï¼")
        return
    
    user_data = data[user_id]
    
    if not user_data.get('is_dead', False):
        await ctx.send("â„¹ï¸ ä½ é‚„æ´»è‘—ï¼")
        return
    
    if user_data.get('current_mission'):
        await ctx.send("âŒ ä½ é‚„åœ¨ä»»å‹™ä¸­ï¼ç­‰å¾…ä»»å‹™å®Œæˆå¾Œæ‰èƒ½å•Ÿå‹•ç”Ÿç‰©æ‰“å°å¾©æ´»ã€‚")
        return
    
    user_data['is_dead'] = False
    user_data['current_hp'] = user_data['max_hp']
    user_data['current_stamina'] = user_data['max_stamina']
    user_data['status_effects'] = []
    
    save_data(data)
    
    embed = discord.Embed(
        title="âœ¨ æ‰“å°æˆåŠŸï¼",
        description=f"ä»»å‹™å·²å®Œæˆï¼Œä½ å·²å¾©æ´»ï¼\nç¾åœ¨å¯ä»¥ç¹¼çºŒé€²è¡Œè¡Œå‹•äº†ã€‚",
        color=discord.Color.green()
    )
    embed.add_field(name="ç”Ÿå‘½å€¼", value=f"â¤ï¸ {user_data['max_hp']}/{user_data['max_hp']}", inline=True)
    embed.add_field(name="é«”åŠ›", value=f"âš¡ {user_data['max_stamina']}/{user_data['max_stamina']}", inline=True)
    
    set_embed_footer(embed, ctx)
    await ctx.send(embed=embed)

# ==================== ä»»å‹™ç³»çµ± ====================
@bot.command(name='missions')
async def list_missions(ctx):
    """æŸ¥çœ‹æ‰€æœ‰å¯ç”¨ä»»å‹™"""
    missions = list_all_missions()
    
    if not missions:
        await ctx.send("ğŸ“­ ç›®å‰æ²’æœ‰å¯ç”¨ä»»å‹™ã€‚")
        return
    
    embed = discord.Embed(
        title="ğŸ“‹ å¯ç”¨ä»»å‹™åˆ—è¡¨",
        description="ä½¿ç”¨ `!mission start [ä»»å‹™ID]` é–‹å§‹ä»»å‹™",
        color=discord.Color.blue()
    )
    
    for mission_id in missions:
        mission_data = load_mission(mission_id)
        if mission_data:
            embed.add_field(
                name=f"ğŸ”¹ {mission_data.get('title', mission_id)}",
                value=f"ID: `{mission_id}`\n{mission_data.get('description', 'ç„¡æè¿°')}",
                inline=False
            )
    
    set_embed_footer(embed, ctx)
    await ctx.send(embed=embed)

@bot.command(name='mission')
async def mission_command(ctx, action: str = None, *, mission_id: str = None):
    """ä»»å‹™ç®¡ç†æŒ‡ä»¤"""
    if not action:
        await ctx.send("âŒ è«‹æŒ‡å®šå‹•ä½œï¼\nå¯ç”¨å‹•ä½œ: `start`, `progress`, `complete`, `abandon`")
        return
    
    data = load_data()
    user_id = str(ctx.author.id)
    
    if user_id not in data:
        await ctx.send("âŒ ä½ é‚„æ²’æœ‰å‰µå»ºè§’è‰²ï¼ä½¿ç”¨ `!start` é–‹å§‹å‰µå»ºã€‚")
        return
    
    user_data = data[user_id]
    
    if action == "start":
        if user_data.get('is_dead', False):
            embed = discord.Embed(
                title="ğŸ’€ ä½ å·²ç¶“æ­»äº¡ï¼",
                description="ä½ ç›®å‰è™•æ–¼æ­»äº¡ç‹€æ…‹ï¼Œç„¡æ³•é–‹å§‹æ–°ä»»å‹™ã€‚",
                color=discord.Color.dark_red()
            )
            set_embed_footer(embed, ctx)
            await ctx.send(embed=embed)
            return
        
        if not mission_id:
            await ctx.send("âŒ è«‹æŒ‡å®šä»»å‹™IDï¼ä¾‹å¦‚: `!mission start corridor_cleaning`")
            return
        
        if user_data.get('current_mission'):
            await ctx.send(f"âŒ ä½ å·²ç¶“åœ¨é€²è¡Œä»»å‹™ `{user_data['current_mission']}`ï¼\nä½¿ç”¨ `!mission abandon` æ”¾æ£„ç•¶å‰ä»»å‹™ã€‚")
            return
        
        mission_data = load_mission(mission_id)
        if not mission_data:
            await ctx.send(f"âŒ æ‰¾ä¸åˆ°ä»»å‹™ `{mission_id}`ï¼ä½¿ç”¨ `!missions` æŸ¥çœ‹å¯ç”¨ä»»å‹™ã€‚")
            return
        
        user_data['current_mission'] = mission_id
        user_data['mission_progress'] = {
            "current_step": "start",
            "completed_steps": [],
            "collected_items": 0,
            "sweep_count": 0
        }
        
        save_data(data)
        
        first_step = mission_data['steps'].get('start', {})
        if 'actions' in first_step:
            for action_data in first_step['actions']:
                if action_data['type'] == 'spawn_items':
                    channel_id = str(ctx.channel.id)
                    if channel_id not in channel_items:
                        channel_items[channel_id] = {}
                    
                    for item_config in action_data['items']:
                        for i in range(item_config['count']):
                            item_id = f"ITEM_{len(channel_items[channel_id]) + 1}"
                            channel_items[channel_id][item_id] = {
                                "name": item_config['name'],
                                "weight": item_config['weight'],
                                "placed_by": "ç³»çµ±"
                            }
                    
                    save_scene_items(channel_items)
        
        embed = discord.Embed(
            title=f"ğŸ“‹ ä»»å‹™é–‹å§‹: {mission_data['title']}",
            description=mission_data.get('description', ''),
            color=discord.Color.green()
        )
        
        if first_step:
            step_desc = first_step.get('description', '')
            step_desc = step_desc.replace('{collected_items}', '0')
            step_desc = step_desc.replace('{sweep_count}', '0')
            
            embed.add_field(
                name="ğŸ“ ç•¶å‰éšæ®µ",
                value=step_desc,
                inline=False
            )
        
        if mission_data.get('recommended_items'):
            recommended = "\n".join([f"â€¢ {item}" for item in mission_data['recommended_items']])
            embed.add_field(
                name="ğŸ’ æ¨è–¦æ”œå¸¶",
                value=recommended,
                inline=False
            )
        
        embed.add_field(name="é›£åº¦", value=mission_data.get('difficulty', 'N/A'), inline=True)
        embed.add_field(name="é è¨ˆæ™‚é–“", value=mission_data.get('estimated_time', 'N/A'), inline=True)
        embed.add_field(name="å±éšªç­‰ç´š", value=mission_data.get('danger_level', 'N/A'), inline=True)
        
        set_embed_footer(embed, ctx)
        await ctx.send(embed=embed)
    
    elif action == "progress":
        if not user_data.get('current_mission'):
            await ctx.send("âŒ ä½ ç›®å‰æ²’æœ‰é€²è¡Œä»»ä½•ä»»å‹™ï¼")
            return
        
        mission_data = load_mission(user_data['current_mission'])
        if not mission_data:
            await ctx.send("âŒ ä»»å‹™æ•¸æ“šéŒ¯èª¤ï¼")
            return
        
        progress = user_data.get('mission_progress', {})
        current_step = progress.get('current_step', 'start')
        
        embed = discord.Embed(
            title=f"ğŸ“‹ ä»»å‹™é€²åº¦: {mission_data['title']}",
            color=discord.Color.blue()
        )
        
        step_data = mission_data['steps'].get(current_step, {})
        step_desc = step_data.get('description', 'ç„¡æè¿°')
        
        step_desc = step_desc.replace('{collected_items}', str(progress.get('collected_items', 0)))
        step_desc = step_desc.replace('{sweep_count}', str(progress.get('sweep_count', 0)))
        
        embed.add_field(
            name="ğŸ“ ç•¶å‰éšæ®µ",
            value=step_desc,
            inline=False
        )
        
        # âœ¨ é¡¯ç¤ºå®Œæˆæ¢ä»¶é€²åº¦
        if 'completion_conditions' in step_data:
            conditions_text = []
            for condition in step_data['completion_conditions']:
                if condition['type'] == 'collect_items':
                    current = progress.get('collected_items', 0)
                    required = condition['count']
                    status = "âœ…" if current >= required else "â³"
                    conditions_text.append(f"{status} æ”¶é›†ç‰©å“: {current}/{required}")
                elif condition['type'] == 'sweep_count':
                    current = progress.get('sweep_count', 0)
                    required = condition['count']
                    status = "âœ…" if current >= required else "â³"
                    conditions_text.append(f"{status} æ¸…æ½”æ¬¡æ•¸: {current}/{required}")
            
            if conditions_text:
                embed.add_field(
                    name="ğŸ“Š å®Œæˆæ¢ä»¶",
                    value="\n".join(conditions_text),
                    inline=False
                )
        
        if 'hints' in step_data:
            hints_text = "\n".join(step_data['hints'])
            embed.add_field(
                name="ğŸ’¡ æç¤º",
                value=hints_text,
                inline=False
            )
        
        embed.add_field(
            name="å·²å®Œæˆæ­¥é©Ÿ",
            value=str(len(progress.get('completed_steps', []))),
            inline=True
        )
        
        set_embed_footer(embed, ctx)
        await ctx.send(embed=embed)
    
    elif action == "complete":
        if not user_data.get('current_mission'):
            await ctx.send("âŒ ä½ ç›®å‰æ²’æœ‰é€²è¡Œä»»å‹™ï¼")
            return
        
        mission_data = load_mission(user_data['current_mission'])
        if not mission_data:
            await ctx.send("âŒ ä»»å‹™æ•¸æ“šéŒ¯èª¤ï¼")
            return
        
        progress = user_data.get('mission_progress', {})
        current_step = progress.get('current_step', 'start')
        
        if current_step != "mission_complete":
            await ctx.send(f"âŒ ä»»å‹™å°šæœªå®Œæˆï¼ç•¶å‰éšæ®µ: `{current_step}`\nä½¿ç”¨ `!mission progress` æŸ¥çœ‹é€²åº¦ã€‚")
            return
        
        rewards = mission_data['steps']['mission_complete'].get('rewards', {})
        user_data['cp'] += rewards.get('cp', 0)
        
        completed_mission = user_data['current_mission']
        user_data['current_mission'] = None
        user_data['mission_progress'] = {}
        
        was_dead = user_data.get('is_dead', False)
        if was_dead:
            user_data['is_dead'] = False
            user_data['current_hp'] = user_data['max_hp']
            user_data['current_stamina'] = user_data['max_stamina']
            user_data['status_effects'] = []
        
        # âœ¨ æ¸…ç©ºç•¶å‰å ´æ™¯çš„æ‰€æœ‰ç‰©å“
        channel_id = str(ctx.channel.id)
        items_cleared = 0
        if channel_id in channel_items:
            items_cleared = len(channel_items[channel_id])
            channel_items[channel_id] = {}
            save_scene_items(channel_items)
        
        save_data(data)
        
        embed = discord.Embed(
            title="âœ… ä»»å‹™å®Œæˆï¼",
            description=f"æ­å–œå®Œæˆä»»å‹™ï¼š**{mission_data['title']}**",
            color=discord.Color.gold()
        )
        
        embed.add_field(
            name="ğŸ’° çå‹µ",
            value=f"â€¢ Cp.: +{rewards.get('cp', 0)}\n"
                  f"â€¢ ç¶“é©—å€¼: +{rewards.get('experience', 0)}",
            inline=False
        )
        
        if was_dead:
            embed.add_field(
                name="âœ¨ è‡ªå‹•å•Ÿå‹•ç”Ÿç‰©æ‰“å°",
                value="ä½ å·²å¾©æ´»ï¼Œå¯ä»¥ç¹¼çºŒè¡Œå‹•äº†ï¼",
                inline=False
            )
        
        if items_cleared > 0:
            embed.add_field(
                name="ğŸ§¹ å ´æ™¯æ¸…ç†",
                value=f"å·²æ¸…ç† {items_cleared} ä»¶å ´æ™¯ç‰©å“",
                inline=False
            )
        
        embed.add_field(name="ç•¶å‰ Cp.", value=f"{user_data['cp']} Cp.<a:spinning_coin:1350848007167545404>", inline=True)
        
        set_embed_footer(embed, ctx)
        await ctx.send(embed=embed)
    
    elif action == "abandon":
        if not user_data.get('current_mission'):
            await ctx.send("âŒ ä½ ç›®å‰æ²’æœ‰é€²è¡Œä»»å‹™ï¼")
            return
        
        old_mission = user_data['current_mission']
        user_data['current_mission'] = None
        user_data['mission_progress'] = {}
        
        save_data(data)
        
        await ctx.send(f"âŒ å·²æ”¾æ£„ä»»å‹™ `{old_mission}`ã€‚")
    
    else:
        await ctx.send(f"âŒ æœªçŸ¥å‹•ä½œ `{action}`ï¼\nå¯ç”¨å‹•ä½œ: `start`, `progress`, `complete`, `abandon`")

# ==================== å…¶ä»–åŠŸèƒ½ ====================
@bot.command(name='heal')
@check_alive
async def heal_self(ctx, *, item_name: str = None):
    """ä½¿ç”¨æ²»ç™‚ç‰©å“æ¢å¾©ç”Ÿå‘½å€¼"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if not item_name:
        await ctx.send("âŒ è«‹æŒ‡å®šè¦ä½¿ç”¨çš„æ²»ç™‚ç‰©å“ï¼ä¾‹å¦‚ï¼š`!heal æ€¥æ•‘åŒ…`")
        return
    
    if item_name not in user_data['inventory'] or user_data['inventory'][item_name] <= 0:
        await ctx.send(f"âŒ ä½ çš„ç‰©å“æ¬„ä¸­æ²’æœ‰ `{item_name}`ã€‚")
        return
    
    items = load_items()
    heal_amount = 0
    
    for category, category_items in items.items():
        if item_name in category_items and "heal" in category_items[item_name]:
            heal_amount = category_items[item_name]["heal"]
            break
    
    if heal_amount == 0:
        await ctx.send(f"âŒ `{item_name}` ä¸æ˜¯æ²»ç™‚ç‰©å“ï¼")
        return
    
    if user_data['current_hp'] >= user_data['max_hp']:
        await ctx.send(f"â¤ï¸ ä½ çš„ç”Ÿå‘½å€¼å·²ç¶“æ»¿äº†ï¼({user_data['max_hp']}/{user_data['max_hp']})")
        return
    
    old_hp = user_data['current_hp']
    user_data['current_hp'] = min(user_data['current_hp'] + heal_amount, user_data['max_hp'])
    actual_heal = user_data['current_hp'] - old_hp
    
    user_data['inventory'][item_name] -= 1
    if user_data['inventory'][item_name] <= 0:
        del user_data['inventory'][item_name]
    
    save_data(data)
    
    embed = discord.Embed(
        title="ğŸ’š æ²»ç™‚æˆåŠŸï¼",
        description=f"ä½¿ç”¨äº† `{item_name}`",
        color=discord.Color.green()
    )
    embed.add_field(name="æ¢å¾©é‡", value=f"+{actual_heal} HP", inline=True)
    embed.add_field(name="ç•¶å‰ç”Ÿå‘½å€¼", value=f"{user_data['current_hp']}/{user_data['max_hp']}", inline=True)
    set_embed_footer(embed, ctx)
    
    await ctx.send(embed=embed)

@bot.command(name='eat')
@check_alive
async def eat_food(ctx, *, food_name: str = None):
    """åƒé£Ÿç‰©æ¢å¾©é«”åŠ›"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if 'current_stamina' not in user_data:
        user_data['current_stamina'] = user_data['stats'].get('æœ€å¤§é«”åŠ›', 100)
        user_data['max_stamina'] = user_data['stats'].get('æœ€å¤§é«”åŠ›', 100)
        save_data(data)
    
    if not food_name:
        await ctx.send("âŒ è«‹æŒ‡å®šè¦åƒçš„é£Ÿç‰©ï¼ä¾‹å¦‚ï¼š`!eat èƒ½é‡æ£’`")
        return
    
    if food_name not in user_data['inventory'] or user_data['inventory'][food_name] <= 0:
        await ctx.send(f"âŒ ä½ çš„ç‰©å“æ¬„ä¸­æ²’æœ‰ `{food_name}`ã€‚")
        return
    
    items = load_items()
    stamina_amount = 0
    
    for category, category_items in items.items():
        if food_name in category_items and "stamina" in category_items[food_name]:
            stamina_amount = category_items[food_name]["stamina"]
            break
    
    if stamina_amount == 0:
        await ctx.send(f"âŒ `{food_name}` ä¸æ˜¯é£Ÿç‰©ï¼")
        return
    
    if user_data['current_stamina'] >= user_data['max_stamina']:
        await ctx.send(f"âš¡ ä½ çš„é«”åŠ›å·²ç¶“æ»¿äº†ï¼({user_data['max_stamina']}/{user_data['max_stamina']})")
        return
    
    old_stamina = user_data['current_stamina']
    user_data['current_stamina'] = min(user_data['current_stamina'] + stamina_amount, user_data['max_stamina'])
    actual_restore = user_data['current_stamina'] - old_stamina
    
    user_data['inventory'][food_name] -= 1
    if user_data['inventory'][food_name] <= 0:
        del user_data['inventory'][food_name]
    
    save_data(data)
    
    fatigue_status = get_fatigue_status(user_data['current_stamina'], user_data['max_stamina'])
    fatigue_color_emoji = get_fatigue_color(fatigue_status)
    
    embed = discord.Embed(
        title="ğŸ½ï¸ é€²é£ŸæˆåŠŸï¼",
        description=f"åƒäº† `{food_name}`",
        color=discord.Color.green()
    )
    embed.add_field(name="æ¢å¾©é‡", value=f"+{actual_restore} é«”åŠ›", inline=True)
    embed.add_field(name="ç•¶å‰é«”åŠ›", value=f"âš¡ {user_data['current_stamina']}/{user_data['max_stamina']}", inline=True)
    embed.add_field(name="ç–²å‹ç‹€æ…‹", value=f"{fatigue_color_emoji} {fatigue_status}", inline=True)
    set_embed_footer(embed, ctx)
    
    await ctx.send(embed=embed)

@bot.command(name='work')
@check_alive
async def work(ctx, amount: int = 20):
    """å·¥ä½œæ¶ˆè€—é«”åŠ›ï¼ˆæ¸¬è©¦ç”¨ï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if 'current_stamina' not in user_data:
        user_data['current_stamina'] = user_data['stats'].get('æœ€å¤§é«”åŠ›', 100)
        user_data['max_stamina'] = user_data['stats'].get('æœ€å¤§é«”åŠ›', 100)
        save_data(data)
    
    if amount <= 0:
        await ctx.send("âŒ æ¶ˆè€—å€¼å¿…é ˆå¤§æ–¼ 0ï¼")
        return
    
    if user_data['current_stamina'] < amount:
        await ctx.send(f"âŒ é«”åŠ›ä¸è¶³ï¼ç›®å‰é«”åŠ›: {user_data['current_stamina']}/{user_data['max_stamina']}\nğŸ’¡ ä½¿ç”¨ `!eat [é£Ÿç‰©åç¨±]` ä¾†æ¢å¾©é«”åŠ›ã€‚")
        return
    
    user_data['current_stamina'] = max(0, user_data['current_stamina'] - amount)
    
    reward = amount * 2
    user_data['cp'] += reward
    
    save_data(data)
    
    fatigue_status = get_fatigue_status(user_data['current_stamina'], user_data['max_stamina'])
    fatigue_color_emoji = get_fatigue_color(fatigue_status)
    
    stamina_percent = (user_data['current_stamina'] / user_data['max_stamina']) * 100
    if stamina_percent > 66:
        color = discord.Color.green()
    elif stamina_percent > 33:
        color = discord.Color.gold()
    else:
        color = discord.Color.red()
    
    embed = discord.Embed(
        title="ğŸ’¼ å·¥ä½œå®Œæˆï¼",
        description=f"æ¶ˆè€—äº† {amount} é»é«”åŠ›",
        color=color
    )
    embed.add_field(name="ç²å¾—å ±é…¬", value=f"ğŸ’° +{reward} Cp.<a:spinning_coin:1350848007167545404>", inline=True)
    embed.add_field(name="ç•¶å‰ Cp.", value=f"ğŸ’° {user_data['cp']} Cp.<a:spinning_coin:1350848007167545404>", inline=True)
    embed.add_field(name="ç•¶å‰é«”åŠ›", value=f"âš¡ {user_data['current_stamina']}/{user_data['max_stamina']}", inline=True)
    embed.add_field(name="ç–²å‹ç‹€æ…‹", value=f"{fatigue_color_emoji} {fatigue_status}", inline=True)
    
    set_embed_footer(embed, ctx)
    
    await ctx.send(embed=embed)

@bot.command(name='poison')
@check_alive
async def add_poison(ctx):
    """æ·»åŠ ä¸­æ¯’ç‹€æ…‹ï¼ˆæ¸¬è©¦ç”¨ï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    add_status_effect(user_id, "ä¸­æ¯’")
    await ctx.send("ğŸ§ª ä½ ä¸­æ¯’äº†ï¼ä½¿ç”¨ `!dash` æŸ¥çœ‹ç‹€æ…‹ã€‚")

@bot.command(name='cure')
@check_alive
async def cure_poison(ctx):
    """æ¸…é™¤æ‰€æœ‰ç‹€æ…‹æ•ˆæœï¼ˆæ¸¬è©¦ç”¨ï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    clear_status_effects(user_id)
    await ctx.send("âœ¨ æ‰€æœ‰ç‹€æ…‹æ•ˆæœå·²æ¸…é™¤ï¼")

@bot.command(name='check')
async def check_scene(ctx):
    """æŸ¥çœ‹å ´æ™¯å…§çš„ç‰©å“ï¼ˆåŒ…å«é‡é‡ï¼‰- æ­»äº¡ç‹€æ…‹ä¹Ÿå¯æŸ¥çœ‹"""
    channel_id = str(ctx.channel.id)
    
    if channel_id not in channel_items or not channel_items[channel_id]:
        await ctx.send("ğŸ“­ é€™å€‹å ´æ™¯å…§æ²’æœ‰ä»»ä½•ç‰©å“ã€‚")
        return
    
    embed = discord.Embed(
        title=f"ğŸ” å ´æ™¯ç‰©å“ - {ctx.channel.name}",
        color=discord.Color.blue()
    )
    
    items_text = ""
    for item_id, item_info in channel_items[channel_id].items():
        item_display = f"**[{item_id}]** {item_info['name']}"
        
        weight = item_info.get('weight', get_item_weight(item_info['name']))
        if weight > 0:
            item_display += f" ({round_weight(weight)} kg)"
        
        item_display += f" (æ”¾ç½®è€…: {item_info['placed_by']})\n"
        items_text += item_display
    
    embed.description = items_text
    set_embed_footer(embed, ctx)
    await ctx.send(embed=embed)

@bot.command(name='drop')
@check_alive
async def drop_item(ctx, *, item_name: str):
    """æ”¾ç½®ç‰©å“åˆ°å ´æ™¯"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    if item_name not in user_data['inventory'] or user_data['inventory'][item_name] <= 0:
        await ctx.send(f"âŒ ä½ çš„ç‰©å“æ¬„ä¸­æ²’æœ‰ `{item_name}`ã€‚")
        return
    
    channel_id = str(ctx.channel.id)
    if channel_id not in channel_items:
        channel_items[channel_id] = {}
    
    item_id = f"ITEM_{len(channel_items[channel_id]) + 1}"
    item_weight = get_item_weight(item_name)
    
    channel_items[channel_id][item_id] = {
        "name": item_name,
        "weight": item_weight,
        "placed_by": ctx.author.display_name
    }
    
    user_data['inventory'][item_name] -= 1
    if user_data['inventory'][item_name] <= 0:
        del user_data['inventory'][item_name]
    
    user_data['current_weight'] = round_weight(user_data['current_weight'] - item_weight)
    
    save_data(data)
    save_scene_items(channel_items)
    
    await ctx.send(f"âœ… ä½ å°‡ `{item_name}` æ”¾ç½®åœ¨å ´æ™¯ä¸­ã€‚(ç‰©å“ç·¨è™Ÿ: {item_id})")

# ==================== ä¿®æ”¹ pick_item æŒ‡ä»¤ï¼Œæ·»åŠ ä»»å‹™é€²åº¦è¿½è¹¤ ====================
@bot.command(name='pick')
@check_alive
async def pick_item(ctx, item_id: str):
    """æ‹¾å–å ´æ™¯ä¸­çš„ç‰©å“"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    channel_id = str(ctx.channel.id)
    
    if channel_id not in channel_items or item_id not in channel_items[channel_id]:
        await ctx.send(f"âŒ æ‰¾ä¸åˆ°ç‰©å“ç·¨è™Ÿ `{item_id}`ã€‚ä½¿ç”¨ `!check` æŸ¥çœ‹å ´æ™¯ç‰©å“ã€‚")
        return
    
    item_info = channel_items[channel_id][item_id]
    item_name = item_info['name']
    
    item_weight = item_info.get('weight', get_item_weight(item_name))
    new_weight = round_weight(user_data['current_weight'] + item_weight)
    
    if new_weight > user_data['stats']['è² é‡ä¸Šé™']:
        await ctx.send(f"âŒ è² é‡è¶…éä¸Šé™ï¼ç‰©å“é‡é‡: {round_weight(item_weight)} kg\nç•¶å‰è² é‡: {round_weight(user_data['current_weight'])}/{user_data['stats']['è² é‡ä¸Šé™']}")
        return
    
    user_data['current_weight'] = new_weight
    
    if item_name in user_data['inventory']:
        user_data['inventory'][item_name] += 1
    else:
        user_data['inventory'][item_name] = 1
    
    del channel_items[channel_id][item_id]
    
    save_data(data)
    save_scene_items(channel_items)
    
    # âœ¨ æª¢æŸ¥æ˜¯å¦åœ¨ä»»å‹™ä¸­ï¼Œä¸¦æ›´æ–°é€²åº¦
    mission_updated = False
    next_step_name = None
    
    if user_data.get('current_mission'):
        result = update_mission_progress(user_id, 'collect_item')
        if result:
            mission_updated, next_step_name = result
    
    base_message = f"âœ… ä½ æ‹¾å–äº† `{item_name}`ã€‚"
    
    if mission_updated and next_step_name:
        mission_data = load_mission(user_data['current_mission'])
        next_step_data = mission_data['steps'].get(next_step_name, {})
        next_step_desc = next_step_data.get('description', 'ç¹¼çºŒä»»å‹™')
        
        # æ›¿æ›è®Šæ•¸
        progress = user_data.get('mission_progress', {})
        next_step_desc = next_step_desc.replace('{collected_items}', str(progress.get('collected_items', 0)))
        next_step_desc = next_step_desc.replace('{sweep_count}', str(progress.get('sweep_count', 0)))
        
        embed = discord.Embed(
            title="ğŸ“‹ ä»»å‹™é€²åº¦æ›´æ–°ï¼",
            description=base_message,
            color=discord.Color.green()
        )
        embed.add_field(
            name="âœ¨ éšæ®µå®Œæˆ",
            value=f"é€²å…¥ä¸‹ä¸€éšæ®µ: **{next_step_name}**",
            inline=False
        )
        embed.add_field(
            name="ğŸ“ ä¸‹ä¸€æ­¥",
            value=next_step_desc,
            inline=False
        )
        set_embed_footer(embed, ctx)
        await ctx.send(embed=embed)
    else:
        await ctx.send(base_message)

# ==================== å•†åº—ç³»çµ± ====================
class ShopView(discord.ui.View):
    def __init__(self, user_id, category: str, ctx):
        super().__init__(timeout=180)
        self.user_id = user_id
        self.category = category
        self.ctx = ctx
        self.items = load_items()
    
    @discord.ui.select(
        placeholder="é¸æ“‡è¦è³¼è²·çš„ç‰©å“",
        options=[]
    )
    async def select_item(self, interaction: discord.Interaction, select: discord.ui.Select):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„å•†åº—ï¼", ephemeral=True)
            return
        
        item_name = select.values[0]
        
        item_data = None
        for cat, items in self.items.items():
            if item_name in items:
                item_data = items[item_name]
                break
        
        if not item_data:
            await interaction.response.send_message("âŒ æ‰¾ä¸åˆ°è©²ç‰©å“ã€‚", ephemeral=True)
            return
        
        view = PurchaseConfirmView(self.user_id, item_name, item_data)
        embed = discord.Embed(
            title=f"ğŸ›’ è³¼è²· {item_name}",
            description=f"**èªªæ˜**: {item_data['description']}\n"
                       f"**åƒ¹æ ¼**: {item_data['price']} Cp.<a:spinning_coin:1350848007167545404>\n"
                       f"**é‡é‡**: {item_data['weight']} kg",
            color=discord.Color.gold()
        )
        set_embed_footer(embed, interaction)
        await interaction.response.send_message(embed=embed, view=view, ephemeral=True)

class PurchaseConfirmView(discord.ui.View):
    def __init__(self, user_id, item_name, item_data):
        super().__init__(timeout=60)
        self.user_id = user_id
        self.item_name = item_name
        self.item_data = item_data
    
    @discord.ui.button(label="ç¢ºèªè³¼è²·", style=discord.ButtonStyle.success, emoji="âœ…")
    async def confirm_purchase(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("é€™ä¸æ˜¯ä½ çš„è³¼è²·æµç¨‹ï¼", ephemeral=True)
            return
        
        data = load_data()
        user_id = str(self.user_id)
        user_data = data[user_id]
        
        if user_data.get('is_dead', False):
            await interaction.response.edit_message(
                content="ğŸ’€ ä½ å·²ç¶“æ­»äº¡ï¼ç„¡æ³•è³¼è²·ç‰©å“ã€‚",
                embed=None,
                view=None
            )
            return
        
        if user_data['cp'] < self.item_data['price']:
            await interaction.response.edit_message(
                content="âŒ Cp. ä¸è¶³ï¼",
                embed=None,
                view=None
            )
            return
        
        new_weight = round_weight(user_data['current_weight'] + self.item_data['weight'])
        if new_weight > user_data['stats']['è² é‡ä¸Šé™']:
            await interaction.response.edit_message(
                content="âŒ è² é‡è¶…éä¸Šé™ï¼",
                embed=None,
                view=None
            )
            return
        
        user_data['cp'] -= self.item_data['price']
        user_data['current_weight'] = new_weight
        
        if self.item_name in user_data['inventory']:
            user_data['inventory'][self.item_name] += 1
        else:
            user_data['inventory'][self.item_name] = 1
        
        save_data(data)
        
        await interaction.response.edit_message(
            content=f"âœ… æˆåŠŸè³¼è²· `{self.item_name}`ï¼\n"
                   f"ğŸ’° å‰©é¤˜ Cp.: {user_data['cp']} Cp.<a:spinning_coin:1350848007167545404>",
            embed=None,
            view=None
        )
    
    @discord.ui.button(label="å–æ¶ˆ", style=discord.ButtonStyle.secondary, emoji="âŒ")
    async def cancel_purchase(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.edit_message(content="å·²å–æ¶ˆè³¼è²·ã€‚", embed=None, view=None)

@bot.command(name='shop')
@check_alive
async def shop(ctx, category: str = None):
    """æ‰“é–‹å•†åº—"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    items = load_items()
    
    if not category:
        embed = discord.Embed(
            title="ğŸ›’ æ˜Ÿéš›æ¸…æ½”å·¥ç·šä¸Šå•†åº—",
            description="ä½¿ç”¨ `!shop [åˆ†é¡]` ç€è¦½å•†å“\n\nå¯ç”¨åˆ†é¡:",
            color=discord.Color.gold()
        )
        for cat in items.keys():
            embed.add_field(name=cat, value=f"`!shop {cat}`", inline=True)
        
        set_embed_footer(embed, ctx)
        await ctx.send(embed=embed)
        return
    
    if category not in items:
        await ctx.send(f"âŒ æ‰¾ä¸åˆ°åˆ†é¡ `{category}`ã€‚ä½¿ç”¨ `!shop` æŸ¥çœ‹æ‰€æœ‰åˆ†é¡ã€‚")
        return
    
    embed = discord.Embed(
        title=f"ğŸ›’ {category}",
        color=discord.Color.gold()
    )
    
    for item_name, item_info in items[category].items():
        embed.add_field(
            name=f"{item_name} - {item_info['price']} Cp.<a:spinning_coin:1350848007167545404>",
            value=f"{item_info['description']}\né‡é‡: {item_info['weight']} kg",
            inline=False
        )
    
    set_embed_footer(embed, ctx)
    
    options = [
        discord.SelectOption(label=item_name, description=f"{item_info['price']} Cp.")
        for item_name, item_info in items[category].items()
    ]
    
    view = ShopView(ctx.author.id, category, ctx)
    view.children[0].options = options[:25]
    
    await ctx.send(embed=embed, view=view)

# ==================== æ¯æ—¥é ˜å– ====================# 
@bot.command(name='é ˜å–ä¾¿ç•¶')
@check_alive
async def daily_food(ctx):
    """æ¯æ—¥é ˜å–ä¾¿ç•¶"""
    data = load_data()
    user_id = str(ctx.author.id)
    user_data = data[user_id]

    if 'last_take_food_date' not in user_data:
        user_data['last_take_food_date'] = None

    now = datetime.now()
    today = now.date()
    
    last_take_food = user_data.get('last_take_food_date')
    
    if last_take_food:
        last_take_food_date = datetime.fromisoformat(last_take_food).date()
        
        if last_take_food_date == today:
            tomorrow = datetime.combine(today + timedelta(days=1), datetime.min.time())
            time_until_reset = tomorrow - now
            hours = int(time_until_reset.total_seconds() // 3600)
            minutes = int((time_until_reset.total_seconds() % 3600) // 60)
            
            embed = discord.Embed(
                title="âŒ ä»Šå¤©å·²ç¶“é ˜å–ä¾¿ç•¶äº†ï¼",
                description=f"ä½ ä»Šå¤©å·²ç¶“é ˜å–éæ¯æ—¥ä¾¿ç•¶äº†ã€‚",
                color=discord.Color.red()
            )
            embed.add_field(
                name="â° ä¸‹æ¬¡é ˜å–æ™‚é–“",
                value=f"{hours} å°æ™‚ {minutes} åˆ†é˜å¾Œ",
                inline=False
            )
            set_embed_footer(embed, ctx)
            await ctx.send(embed=embed)
            return
    
    # âœ… æ›´æ–°é ˜å–æ™‚é–“
    user_data['last_take_food_date'] = now.isoformat()
    
    # âœ… ç¢ºä¿ inventory å­˜åœ¨
    if 'inventory' not in user_data:
        user_data['inventory'] = {}
    
    if 'ç‡Ÿé¤Šé¤' not in user_data['inventory']:
        user_data['inventory']['ç‡Ÿé¤Šé¤'] = 0
    
    user_data['inventory']['ç‡Ÿé¤Šé¤'] += 3
    
    save_data(data)
    
    embed = discord.Embed(
        title="ğŸ± ä¾¿ç•¶é ˜å–æˆåŠŸï¼",
        description=f"ä½ ç²å¾—äº† **3 ä»½ç‡Ÿé¤Šé¤**ï¼",
        color=discord.Color.green()
    )
    embed.add_field(
        name="ğŸ“¦ ç•¶å‰ç‡Ÿé¤Šé¤æ•¸é‡",
        value=f"{user_data['inventory']['ç‡Ÿé¤Šé¤']} ä»½",
        inline=True
    )
    embed.add_field(
        name="â° ä¸‹æ¬¡é ˜å–æ™‚é–“",
        value="æ˜å¤©åˆå¤œ 12:00",
        inline=True
    )
    set_embed_footer(embed, ctx)
    await ctx.send(embed=embed)
        

@bot.command(name='æ¯æ—¥ç°½åˆ°')
@check_alive
async def daily_checkin(ctx):
    """æ¯æ—¥ç°½åˆ°é ˜å–å·¥è³‡ï¼ˆæ¯å¤©åªèƒ½ç°½åˆ°ä¸€æ¬¡ï¼Œåˆå¤œ 12:00 é‡ç½®ï¼‰"""
    data = load_data()
    user_id = str(ctx.author.id)
    
    user_data = data[user_id]
    
    # è‡ªå‹•åˆå§‹åŒ–ç°½åˆ°ç›¸é—œæ¬„ä½ï¼ˆå‘ä¸‹ç›¸å®¹èˆŠè³‡æ–™ï¼‰
    if 'last_checkin_date' not in user_data:
        user_data['last_checkin_date'] = None
    if 'checkin_streak' not in user_data:
        user_data['checkin_streak'] = 0
    
    # å–å¾—ç•¶å‰æ™‚é–“å’Œæ—¥æœŸ
    now = datetime.now()
    today = now.date()
    
    # æª¢æŸ¥ä¸Šæ¬¡ç°½åˆ°æ—¥æœŸ
    last_checkin = user_data.get('last_checkin_date')
    
    if last_checkin:
        # å°‡å­—ä¸²è½‰æ›ç‚ºæ—¥æœŸç‰©ä»¶
        last_checkin_date = datetime.fromisoformat(last_checkin).date()
        
        # å¦‚æœä»Šå¤©å·²ç¶“ç°½åˆ°é
        if last_checkin_date == today:
            # è¨ˆç®—è·é›¢ä¸‹æ¬¡ç°½åˆ°çš„æ™‚é–“
            tomorrow = datetime.combine(today + timedelta(days=1), datetime.min.time())
            time_until_reset = tomorrow - now
            hours = int(time_until_reset.total_seconds() // 3600)
            minutes = int((time_until_reset.total_seconds() % 3600) // 60)
            
            embed = discord.Embed(
                title="âŒ ä»Šå¤©å·²ç¶“ç°½åˆ°éäº†ï¼",
                description=f"ä½ ä»Šå¤©å·²ç¶“é ˜å–éæ¯æ—¥å·¥è³‡äº†ã€‚",
                color=discord.Color.red()
            )
            embed.add_field(
                name="â° ä¸‹æ¬¡ç°½åˆ°æ™‚é–“",
                value=f"{hours} å°æ™‚ {minutes} åˆ†é˜å¾Œï¼ˆæ˜å¤©åˆå¤œ 12:00ï¼‰",
                inline=False
            )
            embed.add_field(
                name="ä¸Šæ¬¡ç°½åˆ°æ™‚é–“",
                value=datetime.fromisoformat(last_checkin).strftime("%Y-%m-%d %H:%M:%S"),
                inline=False
            )
            set_embed_footer(embed, ctx)
            await ctx.send(embed=embed)
            return
    
    # åŸ·è¡Œç°½åˆ°
    daily_salary = 50
    user_data['cp'] += daily_salary
    user_data['last_checkin_date'] = now.isoformat()  # è¨˜éŒ„ç°½åˆ°æ™‚é–“
    
    # è¨ˆç®—é€£çºŒç°½åˆ°å¤©æ•¸
    if last_checkin:
        last_checkin_date = datetime.fromisoformat(last_checkin).date()
        if last_checkin_date == today - timedelta(days=1):
            # é€£çºŒç°½åˆ°
            user_data['checkin_streak'] = user_data.get('checkin_streak', 0) + 1
        else:
            # ä¸­æ–·é€£çºŒç°½åˆ°
            user_data['checkin_streak'] = 1
    else:
        user_data['checkin_streak'] = 1
    
    # é€£çºŒç°½åˆ°çå‹µ
    streak = user_data.get('checkin_streak', 1)
    bonus = 0
    if streak >= 7:
        bonus = 20  # é€£çºŒ 7 å¤©é¡å¤–çå‹µ
    elif streak >= 3:
        bonus = 10  # é€£çºŒ 3 å¤©é¡å¤–çå‹µ
    
    if bonus > 0:
        user_data['cp'] += bonus
    
    save_data(data)
    
    embed = discord.Embed(
        title="âœ… ç°½åˆ°æˆåŠŸï¼",
        description=f"ä½ ç²å¾—äº†æ¯æ—¥å·¥è³‡ {daily_salary} Cp.<a:spinning_coin:1350848007167545404>ï¼",
        color=discord.Color.green()
    )
    
    if bonus > 0:
        embed.add_field(
            name="ğŸ é€£çºŒç°½åˆ°çå‹µ",
            value=f"é€£çºŒç°½åˆ° {streak} å¤©ï¼Œé¡å¤–ç²å¾— {bonus} Cp.<a:spinning_coin:1350848007167545404>ï¼",
            inline=False
        )
    
    total_earned = daily_salary + bonus
    embed.add_field(
        name="ğŸ’° æœ¬æ¬¡ç²å¾—",
        value=f"{total_earned} Cp.<a:spinning_coin:1350848007167545404>",
        inline=True
    )
    embed.add_field(
        name="ğŸ”¥ é€£çºŒç°½åˆ°",
        value=f"{streak} å¤©",
        inline=True
    )
    embed.add_field(
        name="ç•¶å‰ Cp.",
        value=f"{user_data['cp']} Cp.<a:spinning_coin:1350848007167545404>",
        inline=False
    )
    
    # ä¸‹æ¬¡ç°½åˆ°æç¤º
    tomorrow = datetime.combine(today + timedelta(days=1), datetime.min.time())
    embed.set_footer(
        text=f"ä¸‹æ¬¡ç°½åˆ°æ™‚é–“: {tomorrow.strftime('%Y-%m-%d 00:00:00')} | è«‹æ±‚è€…: {ctx.author.display_name}",
        icon_url=ctx.author.avatar.url if ctx.author.avatar else None
    )
    
    await ctx.send(embed=embed)

# ==================== Bot äº‹ä»¶ ====================
@bot.event
async def on_ready():
    print(f'{bot.user} å·²ä¸Šç·šï¼')
    print(f'Bot ID: {bot.user.id}')
    print('------')
    
    try:
        synced = await bot.tree.sync()
        print(f'åŒæ­¥äº† {len(synced)} å€‹æ–œç·šå‘½ä»¤')
    except Exception as e:
        print(f'åŒæ­¥å‘½ä»¤æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}')

@bot.event
async def on_command_error(ctx, error):
    if isinstance(error, commands.CommandNotFound):
        await ctx.send("âŒ æ‰¾ä¸åˆ°è©²æŒ‡ä»¤ã€‚ä½¿ç”¨ `!helpme` æŸ¥çœ‹å¯ç”¨æŒ‡ä»¤ã€‚")
    elif isinstance(error, commands.MissingRequiredArgument):
        await ctx.send(f"âŒ ç¼ºå°‘å¿…è¦åƒæ•¸: {error.param.name}")
    else:
        await ctx.send(f"âŒ ç™¼ç”ŸéŒ¯èª¤: {str(error)}")

# ==================== å¹«åŠ©æŒ‡ä»¤ ====================
@bot.command(name='helpme')
async def help_command(ctx):
    """é¡¯ç¤ºå¹«åŠ©è¨Šæ¯"""
    embed = discord.Embed(
        title="å¤©é«”æ¸…æƒå…¬å¸ Bot æŒ‡ä»¤åˆ—è¡¨",
        description="æ­¡è¿ä¾†åˆ°å…¨å®‡å®™æœ€å€¼å¾—ä¿¡è³´çš„æ¸…æ½”å…¬å¸ï¼",
        color=discord.Color.blue()
    )
    
    embed.add_field(
        name="ğŸ“ è§’è‰²ç®¡ç†",
        value="`!start` - å‰µå»ºè§’è‰²\n"
              "`!dash` - æŸ¥çœ‹è§’è‰²é¢æ¿\n"
              "`!transfer [@å…¶ä»–ç©å®¶] [é‡‘é¡]` - é€²è¡ŒCp.è½‰è³¬\n"
              "`!æ¯æ—¥ç°½åˆ°` - æ¯æ—¥ç°½åˆ°é ˜å·¥è³‡ ğŸ”’",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ”§ å·¥å…·ç³»çµ±",
        value="`!equip [å·¥å…·åç¨±]` - è£å‚™å·¥å…·åˆ°æ‰‹æŒæ¬„ä½ ğŸ”’\n"
              "`!equip` - è§£é™¤è£å‚™ ğŸ”’\n"
              "`!refill [æ¸…æ½”åŠ‘é¡å‹]` - æ³¨æ»¿æ¸…æ½”åŠ‘ï¼ˆé è¨­æ¨™æº–æ¸…æ½”åŠ‘ï¼‰ğŸ”’\n"
              "`!use [å·¥å…·åç¨±]` - ä½¿ç”¨å·¥å…·ï¼ˆè‡ªå‹•è¿½è¹¤ä»»å‹™é€²åº¦ï¼‰ğŸ”’\n"
              "`!cut [ç‰©å“ç·¨è™Ÿ]` - ä½¿ç”¨åˆ†è§£æ§åˆ‡å‰²ç‰©å“ï¼ˆé‡é‡æ¸›åŠï¼‰ğŸ”’",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ“‹ ä»»å‹™ç³»çµ±",
        value="`!missions` - æŸ¥çœ‹æ‰€æœ‰å¯ç”¨ä»»å‹™\n"
              "`!mission start [ä»»å‹™ID]` - é–‹å§‹ä»»å‹™ ğŸ”’\n"
              "`!mission progress` - æŸ¥çœ‹ä»»å‹™é€²åº¦ï¼ˆé¡¯ç¤ºå®Œæˆæ¢ä»¶ï¼‰\n"
              "`!mission complete` - å®Œæˆä»»å‹™ï¼ˆå¾©æ´»æ‰€æœ‰æ­»äº¡éšŠå“¡ä¸¦æ¸…ç©ºå ´æ™¯ï¼‰\n"
              "`!mission abandon` - æ”¾æ£„ä»»å‹™",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ’€ æ­»äº¡ç³»çµ±",
        value="`!damage [æ•¸å€¼]` - å—åˆ°å‚·å®³ï¼ˆæ­»äº¡å¾Œæ‰è½å±é«”ï¼‰\n"
              "`!print` - å•Ÿå‹•ç”Ÿç‰©æ‰“å°ï¼ˆåƒ…ä»»å‹™å®Œæˆå¾Œï¼‰\n"
              "`!attack [@å…¶ä»–ç©å®¶]` - æ”»æ“Šå…¶ä»–ç©å®¶",
        inline=False
    )
    
    embed.add_field(
        name="â¤ï¸ ç”Ÿå‘½å€¼ç³»çµ±",
        value="`!heal [ç‰©å“åç¨±]` - ä½¿ç”¨æ²»ç™‚ç‰©å“æ¢å¾©ç”Ÿå‘½å€¼ ğŸ”’",
        inline=False
    )
    
    embed.add_field(
        name="âš¡ é«”åŠ›ç³»çµ±",
        value="`!eat [é£Ÿç‰©åç¨±]` - åƒé£Ÿç‰©æ¢å¾©é«”åŠ› ğŸ”’\n"
              "`!work [æ¶ˆè€—å€¼]` - å·¥ä½œæ¶ˆè€—é«”åŠ›ç²å¾—Cp.ï¼ˆé è¨­20ï¼‰ğŸ”’\n"
              "`!é ˜å–ä¾¿ç•¶]` - æ¯æ—¥é ˜å–ä¾¿ç•¶ğŸ”’",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ’« ç‹€æ…‹æ•ˆæœï¼ˆæ¸¬è©¦ç”¨ï¼‰",
        value="`!poison` - æ·»åŠ ä¸­æ¯’ç‹€æ…‹ ğŸ”’\n"
              "`!cure` - æ¸…é™¤æ‰€æœ‰ç‹€æ…‹æ•ˆæœ ğŸ”’",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ›’ å•†åº—ç³»çµ±",
        value="`!shop` - æŸ¥çœ‹å•†åº—åˆ†é¡ ğŸ”’\n"
              "`!shop [åˆ†é¡]` - ç€è¦½æŒ‡å®šåˆ†é¡å•†å“ ğŸ”’",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ”§ å ´æ™¯ç‰©å“",
        value="`!check` - æŸ¥çœ‹å ´æ™¯ç‰©å“\n"
              "`!drop [ç‰©å“åç¨±]` - æ”¾ç½®ç‰©å“ ğŸ”’\n"
              "`!pick [ç‰©å“ç·¨è™Ÿ]` - æ‹¾å–ç‰©å“ï¼ˆè‡ªå‹•è¿½è¹¤ä»»å‹™é€²åº¦ï¼‰ğŸ”’",
        inline=False
    )
    
    embed.add_field(
        name="ğŸ”’ èªªæ˜",
        value="å¸¶æœ‰ ğŸ”’ æ¨™è¨˜çš„æŒ‡ä»¤åœ¨æ­»äº¡ç‹€æ…‹ä¸‹ç„¡æ³•ä½¿ç”¨ã€‚\n"
              "æ­»äº¡å¾Œè«‹ç­‰å¾…ä»»å‹™å®Œæˆæˆ–ä½¿ç”¨ `!print` å•Ÿå‹•ç”Ÿç‰©æ‰“å°ã€‚\n\n",
        inline=False
    )
    
    set_embed_footer(embed, ctx)
    
    await ctx.send(embed=embed)

# ==================== å•Ÿå‹• Bot ====================
if __name__ == "__main__":
    TOKEN = 'MTM1MDc3NTUxMzIzNjM3NzcwMA.GgSyvZ.i2fbgv2iMYS8qMJDuxQ1frKAYV_JoDTyL9edNQ'
    
    print("æ­£åœ¨å•Ÿå‹•å¤©é«”æ¸…æƒå…¬å¸ Bot...")
    print("è«‹ç¢ºä¿å·²å®‰è£ discord.py å’Œ aiohttp:")
    print("pip install discord.py aiohttp")
    print("------")
    
    bot.run(TOKEN)